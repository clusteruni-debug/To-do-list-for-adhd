<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#667eea">
  <link rel="manifest" href="./manifest.json">
  <title>Navigator - 생존형 할일 관리</title>

  <!-- Pretendard 폰트 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyDryb8MH0Mwkh1yP8yPCjdTbEvjr97mmmE",
      authDomain: "navigator-todo.firebaseapp.com",
      projectId: "navigator-todo",
      storageBucket: "navigator-todo.firebasestorage.app",
      messagingSenderId: "1020977741609",
      appId: "1:1020977741609:web:32ec5ad48329f80a3f0138"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // 전역 변수로 노출
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseProvider = provider;
    window.firebaseSignIn = signInWithPopup;
    window.firebaseSignOut = signOut;
    window.firebaseDoc = doc;
    window.firebaseSetDoc = setDoc;
    window.firebaseGetDoc = getDoc;
    window.firebaseOnSnapshot = onSnapshot;
    window.firebaseOnAuthStateChanged = onAuthStateChanged;

    // Firebase 준비 완료 이벤트
    window.dispatchEvent(new Event('firebase-ready'));
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    /* 다크 테마 (기본) */
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #151515;
      --bg-tertiary: #1f1f1f;
      --bg-card: #151515;
      --text-primary: #f5f5f5;
      --text-secondary: #a0a0a0;
      --text-muted: #707070;
      --border-color: #2a2a2a;
      --border-light: #1f1f1f;
      --shadow-color: rgba(0, 0, 0, 0.4);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
    }

    /* 라이트 테마 */
    body[data-theme="light"] {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f3f4;
      --bg-card: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --border-color: #e0e0e0;
      --border-light: #f1f3f4;
      --shadow-color: rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: 'Pretendard Variable', 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
      line-height: 1.6;
      letter-spacing: -0.02em;
      font-weight: 400;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 100px;
    }

    /* PC 레이아웃 (1024px 이상) */
    @media (min-width: 1024px) {
      .app {
        padding: 30px 40px;
      }

      .header h1 {
        font-size: 42px;
      }

      .pc-layout {
        display: grid;
        grid-template-columns: 1fr 1fr 380px;
        gap: 24px;
        align-items: start;
      }

      .pc-column-left {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .pc-column-center {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .pc-column-right {
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: sticky;
        top: 80px;
      }

      .shuttle-status {
        padding: 24px;
      }

      .next-action {
        padding: 35px;
      }

      .task-title {
        font-size: 32px;
      }

      .quick-add-input {
        padding: 18px;
        font-size: 17px;
      }

      .task-item {
        padding: 18px;
      }

      .task-item:hover {
        border-color: #667eea;
        transform: translateX(4px);
      }

      .stat-card {
        padding: 20px;
      }

      .stat-value {
        font-size: 32px;
      }

      .tab-nav {
        justify-content: center;
        gap: 15px;
      }

      .tab-btn {
        padding: 14px 28px;
        font-size: 15px;
      }
    }

    /* 태블릿 레이아웃 (768px - 1023px) */
    @media (min-width: 768px) and (max-width: 1023px) {
      .app {
        max-width: 720px;
        padding: 25px;
      }

      .stats {
        grid-template-columns: repeat(3, 1fr);
      }

      .tablet-two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
    }

    /* 모바일 (767px 이하) - 기존 유지 */
    @media (max-width: 767px) {
      .app {
        max-width: 600px;
        padding: 15px;
      }

      .pc-layout {
        display: block;
      }

      .pc-column-left,
      .pc-column-center,
      .pc-column-right {
        display: contents;
      }
    }

    /* 탭 네비게이션 */
    .tab-nav {
      display: flex;
      gap: 6px;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      padding: 8px;
      border-radius: var(--radius-md);
      overflow-x: auto;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px var(--shadow-color);
      border: 1px solid var(--border-color);
    }

    .tab-nav::-webkit-scrollbar {
      display: none;
    }

    .tab-btn {
      padding: 10px 16px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
      white-space: nowrap;
      letter-spacing: -0.01em;
    }

    .tab-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .tab-btn.active {
      background: #667eea;
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .header-left {
      text-align: left;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 6px;
      font-weight: 700;
      letter-spacing: -0.03em;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
    }

    .theme-toggle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: var(--bg-tertiary);
      transform: scale(1.05);
    }
    
    .shuttle-status {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 20px;
      cursor: pointer;
      transition: transform 0.2s;
      user-select: none;
    }
    
    .shuttle-status:active {
      transform: scale(0.98);
    }
    
    .shuttle-status.failed {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .shuttle-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .shuttle-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
      letter-spacing: -0.01em;
    }

    .shuttle-desc {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 400;
    }

    /* 현재 시간 & 남은 시간 표시 */
    .current-time-section {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .current-time-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .current-time-clock {
      font-size: 28px;
      font-weight: 700;
      font-family: 'Pretendard Variable', monospace;
      font-variant-numeric: tabular-nums;
      color: #fff;
      letter-spacing: -0.02em;
    }

    .current-time-mode {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .current-time-mode-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .current-time-mode-value {
      font-size: 14px;
      color: #667eea;
      font-weight: bold;
    }

    .current-time-mode-value.회사 { color: #667eea; }
    .current-time-mode-value.생존 { color: #f5576c; }
    .current-time-mode-value.여유 { color: #48bb78; }
    .current-time-mode-value.출근 { color: #f6ad55; }
    .current-time-mode-value.주말 { color: #f093fb; }
    .current-time-mode-value.휴식 { color: var(--text-secondary); }

    .current-time-right {
      text-align: right;
    }

    .time-remaining-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .time-remaining-value {
      font-size: 18px;
      font-weight: bold;
      color: #f093fb;
    }

    .time-remaining-value.urgent {
      color: #f5576c;
      animation: pulse 1s infinite;
    }
    
    .mode-indicator {
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid var(--border-color);
    }
    
    .time-remaining {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      border: 2px solid #333;
    }
    
    .time-remaining.panic {
      border-color: #f5576c;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .time-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }
    
    .time-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .time-warning {
      font-size: 14px;
      color: #f5576c;
      margin-top: 10px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    @media (max-width: 500px) {
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .stat-card {
      background: var(--bg-secondary);
      padding: 12px 8px;
      border-radius: var(--radius-md);
      text-align: center;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all var(--transition-normal);
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--shadow-color);
      border-color: #667eea;
    }
    
    .stat-value {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0;
      white-space: nowrap;
    }

    /* 데이터 인사이트 섹션 */
    .insights-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .insights-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .insight-card {
      background: var(--bg-primary);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
    }

    .insight-card:last-child {
      margin-bottom: 0;
    }

    .insight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .insight-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .insight-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--accent-color);
    }

    .insight-bar-container {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 60px;
      margin-top: 8px;
    }

    .insight-bar {
      flex: 1;
      background: var(--accent-color);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .insight-bar.peak {
      opacity: 1;
      background: linear-gradient(180deg, #667eea, #764ba2);
    }

    .insight-bar-labels {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .insight-bar-label {
      flex: 1;
      text-align: center;
      font-size: 10px;
      color: var(--text-secondary);
    }

    /* 파이 차트 (CSS로 구현) */
    .pie-chart-container {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 12px;
    }

    .pie-chart {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      position: relative;
      flex-shrink: 0;
    }

    .pie-legend {
      flex: 1;
    }

    .pie-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .pie-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .pie-legend-color.본업 { background: #667eea; }
    .pie-legend-color.부업 { background: #f093fb; }
    .pie-legend-color.일상 { background: #4ecdc4; }
    .pie-legend-color.가족 { background: #ffd93d; }
    .pie-legend-color.기타 { background: #888; }

    .pie-legend-value {
      margin-left: auto;
      color: var(--text-secondary);
      font-size: 12px;
    }

    /* ADHD 특화 기능 */
    .quick-timer-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-timer-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .quick-timer-btn.running {
      background: linear-gradient(135deg, #f5576c, #f093fb);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .quick-timer-display {
      font-family: 'SF Mono', 'Monaco', monospace;
      font-weight: bold;
    }

    /* 축하 효과 */
    .celebration-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 9999;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      animation: confetti-fall 3s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% {
        opacity: 1;
        transform: translateY(0) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg);
      }
    }

    .celebration-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: bold;
      color: #ffd93d;
      text-shadow: 0 0 20px rgba(255, 217, 61, 0.5);
      animation: celebration-pop 0.5s ease-out;
      pointer-events: none;
      z-index: 10000;
    }

    @keyframes celebration-pop {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    /* 동기부여 메시지 */
    .motivation-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      animation: toast-in 0.3s ease-out;
      z-index: 1000;
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* 작업 시작 버튼 강조 */
    .start-now-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .start-now-btn:hover {
      transform: scale(1.05);
    }

    /* 스트릭 불꽃 효과 */
    .streak-fire {
      display: inline-block;
      animation: fire-flicker 0.5s ease-in-out infinite alternate;
    }

    @keyframes fire-flicker {
      from { transform: scale(1); }
      to { transform: scale(1.1); }
    }

    /* 오프라인 표시기 */
    .offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #f5576c, #f093fb);
      color: white;
      text-align: center;
      padding: 6px;
      font-size: 12px;
      font-weight: 500;
      z-index: 9999;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
      }
      to {
        transform: translateY(0);
      }
    }

    .offline-indicator.hidden {
      transform: translateY(-100%);
      transition: transform 0.3s ease-in;
    }

    /* 사용자 프로필 & 동기화 */
    .user-section {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #667eea;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: -0.01em;
    }

    .user-email {
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 400;
    }

    .sync-indicator {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 14px;
      background: white;
      color: #333;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .login-btn:hover {
      background: #f5f5f5;
      transform: translateY(-1px);
    }

    .login-btn img {
      width: 20px;
      height: 20px;
    }

    .logout-btn {
      padding: 6px 12px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: var(--bg-tertiary);
      color: #f5576c;
      border-color: #f5576c;
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .sync-status.syncing {
      color: #667eea;
    }

    .sync-status.synced {
      color: #48bb78;
    }

    .sync-status.error {
      color: #f5576c;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .sync-status.syncing .sync-icon {
      animation: spin 1s linear infinite;
    }

    /* 백업 섹션 */
    .backup-section {
      background: var(--bg-secondary);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .backup-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .backup-buttons {
      display: flex;
      gap: 10px;
    }

    .backup-btn {
      flex: 1;
      padding: 12px;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .backup-btn:hover {
      background: #3a3a3a;
    }

    .backup-btn.export {
      background: #667eea;
    }

    .backup-btn.import {
      background: #48bb78;
    }

    /* 대시보드 */
    .dashboard-section {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .dashboard-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.01em;
    }

    .category-stats {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }

    .category-stat {
      background: var(--bg-tertiary);
      padding: 15px;
      border-radius: 12px;
    }

    .category-stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .category-name {
      font-weight: bold;
      font-size: 16px;
    }

    .category-progress {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.3s;
    }

    .progress-fill.본업 { background: #667eea; }
    .progress-fill.부업 { background: #f093fb; }
    .progress-fill.일상 { background: #48bb78; }
    .progress-fill.가족 { background: #f6ad55; }

    .urgent-list {
      display: grid;
      gap: 10px;
    }

    .urgent-item {
      background: var(--bg-tertiary);
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #f5576c;
    }

    .urgent-item-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .urgent-item-time {
      font-size: 12px;
      color: #f5576c;
    }
    
    /* 빠른 추가 (간소화 버전) */
    .quick-add-simple {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .quick-add-simple .quick-add-input {
      flex: 1;
      border-radius: var(--radius-md);
    }

    .quick-add-simple .quick-add-btn {
      padding: 12px 18px;
      border-radius: var(--radius-md);
    }

    /* 다른 작업 섹션 */
    .other-tasks-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .other-tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      transition: background var(--transition-fast);
    }

    .other-tasks-header:hover {
      background: var(--bg-tertiary);
    }

    .other-tasks-toggle {
      font-size: 12px;
    }

    .search-simple {
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      position: relative;
    }

    .search-simple .search-input {
      width: 100%;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-size: 14px;
    }

    .search-simple .search-clear {
      position: absolute;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
    }

    /* 작업 목록 (내부) */
    .task-list-inner {
      padding: 8px 0;
    }

    .task-item-mini {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      cursor: pointer;
      transition: background var(--transition-fast);
      border-bottom: 1px solid var(--border-light);
    }

    .task-item-mini:last-child {
      border-bottom: none;
    }

    .task-item-mini:hover {
      background: var(--bg-tertiary);
    }

    .task-item-mini-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .task-check-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--border-color);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
      transition: all var(--transition-fast);
    }

    .task-check-btn:hover {
      border-color: #48bb78;
      color: #48bb78;
    }

    .task-item-mini-title {
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-item-mini-category {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      flex-shrink: 0;
      font-weight: 500;
    }

    .task-item-mini-category.본업 { background: rgba(102, 126, 234, 0.2); color: #667eea; }
    .task-item-mini-category.부업 { background: rgba(240, 147, 251, 0.2); color: #f093fb; }
    .task-item-mini-category.일상 { background: rgba(72, 187, 120, 0.2); color: #48bb78; }
    .task-item-mini-category.가족 { background: rgba(246, 173, 85, 0.2); color: #f6ad55; }

    .task-list-more {
      text-align: center;
      padding: 10px;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* 빠른 추가 (기존 버전 - 상세 옵션용) */
    .quick-add {
      background: var(--bg-secondary);
      padding: 16px;
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 12px var(--shadow-color);
    }

    .quick-add:focus-within {
      border-color: #667eea;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
    }
    
    .quick-add-header {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .quick-add-input-group {
      display: flex;
      gap: 10px;
    }
    
    .quick-add-input {
      flex: 1;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
      font-weight: 400;
      line-height: 1.5;
    }

    .quick-add-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }
    
    .quick-add-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }
    
    .quick-add-btn {
      padding: 14px 22px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      white-space: nowrap;
      letter-spacing: -0.01em;
    }
    
    .quick-add-btn:active {
      transform: scale(0.95);
    }
    
    .quick-add-toggle {
      margin-top: 10px;
      text-align: center;
      color: #667eea;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }
    
    /* Next Action */
    .next-action {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 20px var(--shadow-color);
    }
    
    .next-action.panic {
      border-color: #f5576c;
      background: linear-gradient(135deg, #2a1a1a 0%, #1a1a1a 100%);
      animation: pulse-border 1s infinite;
    }
    
    @keyframes pulse-border {
      0%, 100% { border-color: #f5576c; }
      50% { border-color: #ff7a8a; }
    }
    
    .next-action.warning {
      border-color: #ff9500;
    }
    
    .next-action-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .next-action.panic .next-action-label {
      color: #f5576c;
    }
    
    .next-action.warning .next-action-label {
      color: #ff9500;
    }
    
    .task-title {
      font-size: 24px;
      margin-bottom: 18px;
      line-height: 1.4;
      font-weight: 600;
      letter-spacing: -0.02em;
      word-break: keep-all;
    }
    
    .task-meta {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .category {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0;
    }
    
    .category.본업 { background: #667eea; }
    .category.부업 { background: #f093fb; }
    .category.일상 { background: #48bb78; }
    .category.가족 { background: #f6ad55; }
    
    .meta-item {
      background: var(--bg-tertiary);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }
    
    .btn {
      padding: 16px 28px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 12px;
      transition: transform 0.2s, opacity 0.2s;
      user-select: none;
      letter-spacing: -0.01em;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-1px);
    }

    .btn-success {
      background: #48bb78;
      color: white;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: white;
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }
    
    /* 리스트 섹션 */
    .task-list-section {
      margin-bottom: 20px;
    }
    
    .task-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--bg-secondary);
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      user-select: none;
      border: 1px solid var(--border-color);
    }
    
    .task-list-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .task-list-count {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .task-list {
      display: none;
    }
    
    .task-list.show {
      display: block;
    }
    
    .task-item {
      background: var(--bg-secondary);
      padding: 14px 16px;
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
      transition: all var(--transition-normal);
      box-shadow: 0 1px 4px var(--shadow-color);
    }

    .task-item:hover {
      border-color: rgba(102, 126, 234, 0.5);
      box-shadow: 0 2px 8px var(--shadow-color);
    }
    
    .task-item.swiping-left {
      transform: translateX(-100px);
    }
    
    .task-item.swiping-right {
      transform: translateX(100px);
    }
    
    .task-item.completed {
      opacity: 0.6;
      background: #151515;
    }
    
    .task-item.urgent {
      border-color: #f5576c;
      border-width: 2px;
    }
    
    .task-item.warning {
      border-color: #ff9500;
      border-width: 2px;
    }

    /* 드래그 앤 드롭 스타일 */
    .task-item[draggable="true"] {
      cursor: grab;
    }

    .task-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
      border: 2px dashed #667eea;
    }

    .task-item.drag-over {
      border: 2px solid #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .swipe-actions {
      position: absolute;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      font-size: 14px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .task-item.swiping-left .swipe-actions.left,
    .task-item.swiping-right .swipe-actions.right {
      opacity: 1;
    }
    
    .swipe-actions.left {
      left: 0;
      background: #48bb78;
    }
    
    .swipe-actions.right {
      right: 0;
      background: #f5576c;
    }
    
    .task-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    
    .task-item-title {
      font-weight: 600;
      font-size: 15px;
      flex: 1;
      margin-right: 10px;
      line-height: 1.4;
      word-break: keep-all;
      letter-spacing: -0.01em;
    }

    .task-item-title.completed {
      text-decoration: line-through;
      opacity: 0.6;
    }
    
    .task-item-meta {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }
    
    .task-item-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-small {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      background: var(--bg-tertiary);
      color: white;
      transition: transform 0.2s;
      font-weight: 500;
      letter-spacing: -0.01em;
    }
    
    .btn-small:active {
      transform: scale(0.95);
    }
    
    .btn-small.delete {
      background: #f5576c;
    }
    
    .btn-small.go {
      background: #667eea;
    }
    
    .btn-small.complete {
      background: #48bb78;
    }

    .btn-small.uncomplete {
      background: #ff9500;
    }

    .btn-small.edit {
      background: #667eea;
    }

    .btn-small.copy {
      background: #805ad5;
    }

    .hidden-tasks {
      background: var(--bg-secondary);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      border: 1px solid var(--border-color);
    }
    
    .add-task-section {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #667eea;
      border-width: 2px;
    }
    
    .add-task-section h3 {
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
      font-weight: 400;
      line-height: 1.5;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .form-note {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* 태그 스타일 */
    .tags-input-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .selected-tags, .available-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 5px 11px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .tag.selected {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .tag.selected:hover {
      background: #5a6fd6;
    }

    .new-tag-input {
      margin-top: 5px;
    }

    .tag-input {
      padding: 10px 14px !important;
      font-size: 14px !important;
    }

    /* 작업 아이템 내 태그 */
    .task-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 6px;
    }

    .task-tag {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(102, 126, 234, 0.15);
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
      color: #8b9cf7;
    }

    /* 태그 필터 */
    .tag-filter-section {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tag-filter-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .tag-filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag-filter-chip {
      padding: 4px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag-filter-chip:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .tag-filter-chip.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .clear-tag-filter {
      margin-left: 10px;
      padding: 2px 8px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
    }

    .clear-tag-filter:hover {
      border-color: #ff6b6b;
      color: #ff6b6b;
    }

    /* 반복 요일 선택 */
    .repeat-days {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .repeat-day-option {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .repeat-day-option:hover {
      border-color: #667eea;
    }

    .repeat-day-option input[type="checkbox"] {
      display: none;
    }

    .repeat-day-option:has(input:checked) {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .repeat-monthly {
      margin-top: 10px;
    }

    .repeat-monthly .form-input {
      max-width: 120px;
    }

    /* 헤더 액션 버튼 */
    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-btn:hover {
      background: var(--bg-tertiary);
      transform: scale(1.05);
    }

    .header-btn.active {
      background: #667eea;
      border-color: #667eea;
    }

    .header-btn.shuttle-mini.success {
      background: rgba(72, 187, 120, 0.15);
      border-color: #48bb78;
    }

    .header-btn.shuttle-mini.failed {
      background: rgba(245, 87, 108, 0.15);
      border-color: #f5576c;
    }

    .header-streak {
      display: inline-block;
      background: linear-gradient(135deg, #f093fb, #f5576c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
      margin-left: 5px;
    }

    /* 스트릭 stat card */
    .stat-card.streak {
      background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1));
      border-color: rgba(240, 147, 251, 0.3);
    }

    .stat-best {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* 모달 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      max-width: 450px;
      width: 100%;
      border: 1px solid var(--border-color);
      animation: modalIn 0.3s ease;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      padding: 24px 24px 0;
      text-align: center;
    }

    .modal-header h2 {
      font-size: 20px;
      margin: 0;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 0 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* 온보딩 */
    .onboarding-feature {
      display: flex;
      gap: 15px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .onboarding-feature:last-child {
      border-bottom: none;
    }

    .onboarding-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .onboarding-feature strong {
      display: block;
      margin-bottom: 4px;
    }

    .onboarding-feature p {
      font-size: 13px;
      color: var(--text-secondary);
      margin: 0;
    }

    /* 포커스 모드 */
    .focus-mode-container {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 2px solid #667eea;
    }

    .focus-mode-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .focus-mode-hint {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: normal;
    }

    .focus-task {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
    }

    .focus-task-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .focus-task-meta {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .focus-subtasks {
      margin-bottom: 20px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .focus-subtask {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
    }

    .focus-subtask:last-child {
      border-bottom: none;
    }

    .focus-subtask.completed {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .focus-subtask-check {
      font-size: 16px;
      color: #667eea;
    }

    .focus-actions {
      display: flex;
      gap: 12px;
    }

    .btn-large {
      padding: 16px 32px;
      font-size: 18px;
    }

    .focus-remaining {
      text-align: center;
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* 서브태스크 스타일 */
    .subtasks-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .subtask-number {
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #667eea;
      color: white;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .subtask-text {
      flex: 1;
      font-size: 14px;
    }

    .subtask-remove {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }

    .subtask-remove:hover {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }

    .subtask-input {
      padding: 10px 14px !important;
      font-size: 14px !important;
    }

    /* 작업 아이템 내 서브태스크 */
    .task-subtasks {
      margin-top: 8px;
      padding: 8px 10px;
      background: var(--bg-tertiary);
      border-radius: 6px;
    }

    .task-subtask {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 13px;
    }

    .task-subtask-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .task-subtask.completed .task-subtask-text {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .task-subtask-text {
      flex: 1;
    }

    .subtask-progress {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    /* 완료 애니메이션 오버레이 */
    .completion-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .completion-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .completion-content {
      text-align: center;
      transform: scale(0.5);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .completion-overlay.show .completion-content {
      transform: scale(1);
    }

    .completion-check {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 50px;
      box-shadow: 0 0 60px rgba(72, 187, 120, 0.6);
      animation: checkPop 0.5s ease-out;
    }

    @keyframes checkPop {
      0% { transform: scale(0) rotate(-180deg); }
      50% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    .completion-text {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .completion-streak {
      font-size: 20px;
      color: #f6ad55;
      margin-bottom: 10px;
    }

    .completion-task-title {
      font-size: 15px;
      color: #888;
      max-width: 280px;
      margin: 0 auto;
    }

    /* 오늘의 진행률 */
    .today-progress {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .today-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .today-progress-title {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .today-progress-score {
      font-size: 28px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea, #48bb78);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .progress-bar-large {
      height: 10px;
      background: #2a2a3a;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
      border-radius: 5px;
      transition: width 0.5s ease-out;
    }

    .today-stats-row {
      display: flex;
      justify-content: space-around;
      text-align: center;
      padding-top: 12px;
      border-top: 1px solid #2a2a3a;
    }

    .today-stat {
      flex: 1;
    }

    .today-stat-value {
      font-size: 20px;
      font-weight: bold;
    }

    .today-stat-value.completed { color: #48bb78; }
    .today-stat-value.remaining { color: #f093fb; }
    .today-stat-value.streak { color: #f6ad55; }

    .today-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* 토스트 알림 */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-tertiary);
      color: white;
      padding: 14px 24px;
      border-radius: var(--radius-md);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
      font-size: 14px;
      font-weight: 500;
      max-width: 90%;
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .toast.success {
      background: #48bb78;
    }

    .toast.error {
      background: #f5576c;
    }

    /* 히든 파일 인풋 */
    .hidden-input {
      display: none;
    }

    /* 알림 설정 섹션 */
    .notification-section {
      background: var(--bg-secondary);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .notification-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .notification-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .notification-text {
      font-size: 14px;
      color: #ccc;
    }

    .notification-text.granted {
      color: #48bb78;
    }

    .notification-text.denied {
      color: #f5576c;
    }

    .notification-btn {
      padding: 10px 16px;
      background: #667eea;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .notification-btn:hover {
      background: #5a6fd6;
    }

    .notification-btn:disabled {
      background: #444;
      cursor: not-allowed;
    }

    /* 검색 & 필터 스타일 */
    .search-filter-section {
      background: var(--bg-secondary);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .search-input-wrapper {
      position: relative;
      margin-bottom: 12px;
    }

    .search-input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: white;
      font-size: 15px;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .search-clear {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: #666;
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 키보드 단축키 도움말 */
    .shortcuts-help {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 15px;
      z-index: 100;
      display: none;
      max-width: 280px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    .shortcuts-help.show {
      display: block;
    }

    .shortcuts-help-title {
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shortcuts-help-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
    }

    .shortcut-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .shortcut-item:last-child {
      border-bottom: none;
    }

    .shortcut-key {
      background: var(--bg-tertiary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
      color: #667eea;
    }

    .shortcut-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .shortcuts-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      z-index: 99;
    }

    @media (min-width: 1024px) {
      .shortcuts-toggle {
        display: flex;
      }
    }

    /* 포모도로 타이머 */
    .pomodoro-section {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #333;
      text-align: center;
    }

    .pomodoro-section.active {
      border-color: #667eea;
      animation: pomodoro-pulse 2s infinite;
    }

    .pomodoro-section.break {
      border-color: #48bb78;
      background: linear-gradient(135deg, #1a2e1a 0%, #162e16 100%);
    }

    @keyframes pomodoro-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
    }

    .pomodoro-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .pomodoro-time {
      font-size: 56px;
      font-weight: bold;
      font-family: monospace;
      margin-bottom: 8px;
    }

    .pomodoro-status {
      font-size: 14px;
      color: #667eea;
      margin-bottom: 15px;
    }

    .pomodoro-section.break .pomodoro-status {
      color: #48bb78;
    }

    .pomodoro-task {
      font-size: 16px;
      color: #ccc;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }

    .pomodoro-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .pomodoro-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .pomodoro-btn:active {
      transform: scale(0.95);
    }

    .pomodoro-btn.start {
      background: #667eea;
      color: white;
    }

    .pomodoro-btn.pause {
      background: #ff9500;
      color: white;
    }

    .pomodoro-btn.stop {
      background: #f5576c;
      color: white;
    }

    .pomodoro-btn.skip {
      background: var(--bg-tertiary);
      color: white;
    }

    .pomodoro-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    .pomodoro-stat {
      text-align: center;
    }

    .pomodoro-stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .pomodoro-stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: 8px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-chip:hover {
      border-color: #667eea;
    }

    .filter-chip.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .filter-chip.본업.active { background: #667eea; border-color: #667eea; }
    .filter-chip.부업.active { background: #f093fb; border-color: #f093fb; }
    .filter-chip.일상.active { background: #48bb78; border-color: #48bb78; }
    .filter-chip.가족.active { background: #f6ad55; border-color: #f6ad55; }

    /* 전체 목록 탭 스타일 */
    .all-tasks-header {
      margin-bottom: 20px;
    }

    .all-tasks-header h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
      font-weight: 600;
    }

    .all-tasks-summary {
      font-size: 14px;
      color: #888;
    }

    .all-category-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      margin-bottom: 15px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .all-category-header {
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid #667eea;
    }

    .all-category-header.본업 { border-left-color: #667eea; }
    .all-category-header.부업 { border-left-color: #f093fb; }
    .all-category-header.일상 { border-left-color: #48bb78; }
    .all-category-header.가족 { border-left-color: #f6ad55; }

    .all-category-title {
      font-size: 16px;
      font-weight: 600;
    }

    .all-category-count {
      font-size: 13px;
      color: #888;
    }

    .all-task-list {
      border-top: 1px solid var(--border-color);
    }

    .all-task-list.completed-list {
      display: none;
      background: #151515;
    }

    .all-task-list.completed-list.show {
      display: block;
    }

    .all-task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-light);
      gap: 10px;
    }

    .all-task-item:last-child {
      border-bottom: none;
    }

    .all-task-item.urgent {
      background: rgba(255, 107, 107, 0.1);
    }

    .all-task-item.warning {
      background: rgba(255, 193, 7, 0.05);
    }

    .all-task-item.completed {
      opacity: 0.6;
    }

    .all-task-content {
      flex: 1;
      min-width: 0;
    }

    .all-task-title {
      font-size: 14px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .all-task-title.completed {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .all-task-meta {
      font-size: 12px;
      color: #888;
    }

    .all-task-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .all-completed-section {
      border-top: 1px solid var(--border-color);
    }

    .all-completed-toggle {
      padding: 10px 15px;
      font-size: 13px;
      color: #888;
      cursor: pointer;
      background: #1f1f1f;
    }

    .all-completed-toggle:hover {
      background: #252525;
    }

    .all-task-more {
      padding: 8px 15px;
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }

    .search-results-count {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 10px;
    }

    /* 일정 뷰 스타일 */
    .schedule-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .schedule-filter-btn {
      padding: 10px 20px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .schedule-filter-btn.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .schedule-day {
      background: var(--bg-secondary);
      border-radius: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .schedule-day-header {
      background: var(--bg-tertiary);
      padding: 12px 15px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .schedule-day-header.today {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .schedule-day-header.weekend {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .schedule-day-count {
      font-size: 12px;
      opacity: 0.8;
    }

    .schedule-day-tasks {
      padding: 10px;
    }

    .schedule-task {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .schedule-task:last-child {
      margin-bottom: 0;
    }

    .schedule-task-time {
      font-size: 12px;
      color: #667eea;
      min-width: 50px;
    }

    .schedule-task-title {
      flex: 1;
      font-size: 14px;
    }

    .schedule-task-category {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .schedule-empty {
      padding: 15px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    .schedule-timeline {
      position: relative;
      padding-left: 60px;
    }

    .timeline-hour {
      position: relative;
      min-height: 60px;
      border-bottom: 1px solid var(--border-light);
    }

    .timeline-hour-label {
      position: absolute;
      left: -50px;
      top: -8px;
      font-size: 12px;
      color: var(--text-muted);
      width: 40px;
      text-align: right;
    }

    .timeline-task {
      background: #667eea;
      border-radius: 6px;
      padding: 8px 10px;
      margin: 2px 0;
      font-size: 13px;
    }

    .timeline-task.부업 {
      background: #f093fb;
    }

    .timeline-task.일상 {
      background: #48bb78;
    }

    /* PC에서 일정 뷰 그리드 */
    @media (min-width: 1024px) {
      .schedule-week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 15px;
      }

      .schedule-day {
        margin-bottom: 0;
      }
    }

    /* 부업 이벤트 탭 스타일 */
    .events-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
      flex-wrap: wrap;
    }

    .events-header .btn {
      width: auto !important;
      margin-bottom: 0 !important;
      padding: 12px 20px !important;
      font-size: 14px !important;
    }

    .events-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.02em;
      white-space: nowrap;
    }

    .events-section {
      margin-bottom: 28px;
    }

    .events-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 14px;
      padding: 8px 0;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .events-section.submitted .events-section-title {
      color: #48bb78;
    }

    .events-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .events-list.submitted-list.collapsed {
      display: none;
    }

    .event-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      transition: all var(--transition-normal);
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    .event-card:hover {
      border-color: rgba(102, 126, 234, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--shadow-color);
    }

    .event-card.urgent {
      border-left: 4px solid #f5576c;
      background: linear-gradient(90deg, rgba(245,87,108,0.08) 0%, transparent 30%);
    }

    .event-card.warning {
      border-left: 4px solid #ff9500;
      background: linear-gradient(90deg, rgba(255,149,0,0.08) 0%, transparent 30%);
    }

    .event-card.completed {
      opacity: 0.6;
      background: #151515;
    }

    .event-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-light);
    }

    .event-title {
      font-size: 15px;
      font-weight: 600;
      flex: 1;
      margin-right: 12px;
      line-height: 1.4;
    }

    .event-dday {
      font-size: 13px;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--bg-tertiary);
      white-space: nowrap;
    }

    .event-card.urgent .event-dday {
      background: #f5576c;
      color: white;
    }

    .event-card.warning .event-dday {
      background: #ff9500;
      color: white;
    }

    .event-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
      font-size: 13px;
      color: #888;
    }

    .event-meta-divider {
      color: #444;
    }

    .event-tag {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--bg-tertiary);
    }

    .event-tag.organizer {
      background: #667eea22;
      color: #99aaff;
      border: 1px solid #667eea44;
    }

    .event-tag.type {
      background: #f093fb22;
      color: #f5b8ff;
      border: 1px solid #f093fb44;
    }

    .event-date {
      font-size: 13px;
      color: var(--text-muted);
    }

    .event-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      padding-top: 4px;
    }

    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 500;
    }

    .btn-link {
      background: transparent;
      color: #667eea;
      text-decoration: none;
      border: 1px solid #667eea44;
    }

    .btn-link:hover {
      background: #667eea22;
    }

    .btn-submit {
      background: #48bb78;
      color: white;
    }

    .btn-submit:hover {
      background: #38a169;
      transform: scale(1.02);
    }

    .btn-edit {
      background: transparent;
      color: #888;
      padding: 8px 10px;
    }

    .btn-edit:hover {
      color: white;
    }

    .btn-undo {
      background: transparent;
      color: #888;
      border: 1px solid var(--border-color);
    }

    .btn-undo:hover {
      border-color: #ff9500;
      color: #ff9500;
    }

    .btn-delete {
      background: transparent;
      color: var(--text-muted);
    }

    .btn-delete:hover {
      color: #f5576c;
    }

    .events-empty {
      text-align: center;
      padding: 60px 20px;
      background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
      border-radius: 16px;
      border: 1px solid #2a2a2a;
    }

    .events-empty-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }

    .events-empty-text {
      color: var(--text-muted);
      font-size: 15px;
    }

    .events-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
    }

    .events-summary-item {
      text-align: center;
    }

    .events-summary-value {
      font-size: 28px;
      font-weight: bold;
      color: #fff;
    }

    .events-summary-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* PC에서 이벤트 카드 그리드 */
    @media (min-width: 1024px) {
      .events-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      .events-header {
        margin-bottom: 28px;
      }

      .events-title {
        font-size: 26px;
      }
    }

    /* PWA 설치 배너 */
    .install-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: none;
    }

    .install-banner.show {
      display: block;
    }

    .install-banner-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .install-banner-text {
      font-size: 14px;
    }

    .install-banner-btn {
      padding: 10px 20px;
      background: white;
      border: none;
      border-radius: 8px;
      color: #667eea;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }

    .install-banner-close {
      background: transparent;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }

    /* ============================================
       히스토리 / 캘린더 스타일
       ============================================ */

    /* 히스토리 헤더 */
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .history-header h2 {
      font-size: 20px;
      margin: 0;
    }

    .history-summary {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* 주간 요약 카드 */
    .week-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      color: white;
    }

    .week-summary-title {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .week-summary-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .week-stat {
      text-align: center;
    }

    .week-stat-value {
      font-size: 28px;
      font-weight: bold;
    }

    .week-stat-label {
      font-size: 12px;
      opacity: 0.85;
    }

    /* 미니 캘린더 */
    .calendar-container {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .calendar-title {
      font-size: 18px;
      font-weight: bold;
    }

    .calendar-nav {
      display: flex;
      gap: 10px;
    }

    .calendar-nav-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-nav-btn:hover {
      background: #667eea;
      border-color: #667eea;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendar-weekday:first-child {
      color: #f5576c;
    }

    .calendar-weekday:last-child {
      color: #667eea;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      background: var(--bg-tertiary);
      border: 1px solid transparent;
    }

    .calendar-day:hover {
      border-color: #667eea;
    }

    .calendar-day.empty {
      background: transparent;
      cursor: default;
    }

    .calendar-day.today {
      border: 2px solid #667eea;
      font-weight: bold;
    }

    .calendar-day.selected {
      background: #667eea;
      color: white;
    }

    .calendar-day.has-activity {
      background: rgba(102, 126, 234, 0.2);
    }

    .calendar-day.has-activity.level-1 {
      background: rgba(102, 126, 234, 0.2);
    }

    .calendar-day.has-activity.level-2 {
      background: rgba(102, 126, 234, 0.4);
    }

    .calendar-day.has-activity.level-3 {
      background: rgba(102, 126, 234, 0.6);
    }

    .calendar-day.has-activity.level-4 {
      background: rgba(102, 126, 234, 0.8);
      color: white;
    }

    .calendar-day-number {
      font-size: 14px;
    }

    .calendar-day-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #48bb78;
      position: absolute;
      bottom: 4px;
    }

    /* 캘린더 범례 */
    .calendar-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .legend-box {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }

    .legend-box.empty {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
    }

    .legend-box.level-1 { background: rgba(102, 126, 234, 0.2); }
    .legend-box.level-2 { background: rgba(102, 126, 234, 0.4); }
    .legend-box.level-3 { background: rgba(102, 126, 234, 0.6); }
    .legend-box.level-4 { background: rgba(102, 126, 234, 0.8); }

    /* 일별 상세 */
    .day-detail {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .day-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .day-detail-date {
      font-size: 18px;
      font-weight: bold;
    }

    .day-detail-stats {
      display: flex;
      gap: 15px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .day-detail-stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .day-detail-stat.completed {
      color: #48bb78;
    }

    .day-detail-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .day-task-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 10px;
    }

    .day-task-time {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      min-width: 50px;
    }

    .day-task-content {
      flex: 1;
    }

    .day-task-title {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .day-task-title.completed {
      color: #48bb78;
    }

    .day-task-title.incomplete {
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .day-task-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .day-task-status {
      font-size: 20px;
    }

    /* 빈 상태 */
    .day-empty {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
    }

    .day-empty-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    /* 히스토리 리스트 (최근 기록) */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .history-date-group {
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .history-date-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--bg-tertiary);
      cursor: pointer;
    }

    .history-date-header:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .history-date-title {
      font-weight: bold;
    }

    .history-date-count {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .history-date-tasks {
      padding: 10px 15px;
      display: none;
    }

    .history-date-tasks.show {
      display: block;
    }

    .history-task {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .history-task:last-child {
      border-bottom: none;
    }

    .history-task-check {
      color: #48bb78;
      font-size: 16px;
    }

    .history-task-title {
      flex: 1;
      font-size: 14px;
    }

    .history-task-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* 모바일 최적화 */
    @media (max-width: 767px) {
      .week-summary-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .week-stat-value {
        font-size: 22px;
      }

      .calendar-day {
        font-size: 12px;
      }

      .calendar-legend {
        flex-wrap: wrap;
        gap: 10px;
      }
    }

    /* ============================================
       설정 모달 스타일
       ============================================ */

    .settings-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-btn:hover {
      background: var(--bg-tertiary);
      transform: scale(1.05);
    }

    .settings-modal {
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .settings-row:last-child {
      border-bottom: none;
    }

    .settings-label {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .settings-label-icon {
      font-size: 20px;
    }

    .settings-label-text {
      display: flex;
      flex-direction: column;
    }

    .settings-label-title {
      font-weight: 500;
      font-size: 14px;
      letter-spacing: -0.01em;
    }

    .settings-label-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 3px;
      font-weight: 400;
    }

    .settings-input {
      width: 100px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      text-align: center;
      font-family: inherit;
      font-weight: 500;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      color-scheme: dark;
    }

    .settings-input::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
      padding: 0;
      margin: 0 0 0 4px;
    }

    .settings-input:focus {
      outline: none;
      border-color: #667eea;
    }

    /* 라이트 모드 시간 입력 */
    [data-theme="light"] .settings-input {
      color-scheme: light;
    }

    [data-theme="light"] .settings-input::-webkit-calendar-picker-indicator {
      filter: none;
    }

    .settings-time-preview {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      text-align: center;
    }

    .settings-time-preview-title {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .settings-time-preview-timeline {
      display: flex;
      justify-content: space-around;
      align-items: center;
      gap: 5px;
    }

    .timeline-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .timeline-icon {
      font-size: 20px;
    }

    .timeline-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .timeline-arrow {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* ============================================
       일일 목표 진행률 스타일
       ============================================ */

    .daily-goal-section {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .daily-goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .daily-goal-title {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .daily-goal-count {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .daily-goal-count strong {
      color: #667eea;
      font-size: 18px;
    }

    .daily-goal-progress {
      height: 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .daily-goal-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 6px;
      transition: width 0.5s ease;
    }

    .daily-goal-fill.complete {
      background: linear-gradient(90deg, #48bb78, #38a169);
    }

    .daily-goal-fill.over {
      background: linear-gradient(90deg, #f6ad55, #ed8936);
    }

    .daily-goal-message {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .daily-goal-message.success {
      background: rgba(72, 187, 120, 0.15);
      color: #48bb78;
    }

    .daily-goal-message.over {
      background: rgba(246, 173, 85, 0.15);
      color: #f6ad55;
    }

    /* 일일 목표 (한 줄 압축 버전) */
    .daily-goal-compact {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
    }

    .daily-goal-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .daily-goal-emoji {
      font-size: 18px;
    }

    .daily-goal-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .daily-goal-text strong {
      color: #667eea;
      font-weight: 700;
    }

    .daily-goal-bar {
      flex: 1;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .daily-goal-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .daily-goal-bar-fill.complete {
      background: linear-gradient(90deg, #48bb78, #38a169);
    }

    /* 주간 통계 그래프 */
    .weekly-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 120px;
      padding: 10px 0;
      margin-top: 15px;
    }

    .weekly-chart-bar {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .weekly-chart-fill {
      width: 30px;
      background: linear-gradient(180deg, #667eea, #764ba2);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      transition: height 0.3s ease;
    }

    .weekly-chart-fill.today {
      background: linear-gradient(180deg, #48bb78, #38a169);
    }

    .weekly-chart-fill.empty {
      background: var(--bg-tertiary);
    }

    .weekly-chart-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .weekly-chart-label.today {
      color: #48bb78;
      font-weight: bold;
    }

    .weekly-chart-value {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* 목표 설정 인풋 */
    .settings-input-number {
      width: 80px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 18px;
      text-align: center;
      font-family: inherit;
    }

    .settings-input-number:focus {
      outline: none;
      border-color: #667eea;
    }

    /* ============================================
       템플릿 스타일
       ============================================ */

    .templates-section {
      margin-top: 10px;
    }

    .templates-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .templates-toggle:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .templates-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 10px;
    }

    .template-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-chip:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .template-chip-icon {
      font-size: 14px;
    }

    .template-chip-delete {
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      border-radius: 50%;
      margin-left: 4px;
    }

    .template-chip-delete:hover {
      background: rgba(245, 87, 108, 0.2);
      color: #f5576c;
    }

    .template-add-btn {
      padding: 8px 12px;
      background: transparent;
      border: 1px dashed var(--border-color);
      border-radius: 20px;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-add-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .template-empty {
      color: var(--text-muted);
      font-size: 13px;
      text-align: center;
      padding: 10px;
    }

    /* ============================================
       스와이프 힌트 & UX 개선
       ============================================ */

    .swipe-hint {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 12px;
      margin-bottom: 15px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 1px dashed rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      animation: swipeHintPulse 2s ease-in-out infinite;
    }

    @keyframes swipeHintPulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }

    .swipe-hint-icon {
      font-size: 20px;
    }

    .swipe-hint-text {
      line-height: 1.4;
    }

    .swipe-hint-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .swipe-hint-close:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* 저장 표시 */
    .save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      background: #48bb78;
      color: white;
      border-radius: 8px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s, transform 0.3s;
      z-index: 1000;
    }

    .save-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* 동기부여 메시지 스타일 */
    .motivation-message {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, rgba(72, 187, 120, 0.1), rgba(56, 161, 105, 0.1));
      border-radius: 12px;
      margin: 10px 0;
    }

    .motivation-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .motivation-text {
      font-size: 16px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .motivation-sub {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- 완료 애니메이션 오버레이 -->
  <div id="completion-overlay" class="completion-overlay">
    <div class="completion-content">
      <div class="completion-check">✓</div>
      <div class="completion-text">완료!</div>
      <div id="completion-streak" class="completion-streak"></div>
      <div id="completion-task-title" class="completion-task-title"></div>
    </div>
  </div>

  <!-- 파일 업로드용 히든 인풋 -->
  <input type="file" id="file-import" class="hidden-input" accept=".json">

  <!-- 키보드 단축키 도움말 (PC) -->
  <button class="shortcuts-toggle" onclick="toggleShortcutsHelp()" title="단축키 도움말">⌨️</button>
  <div id="shortcuts-help" class="shortcuts-help">
    <div class="shortcuts-help-title">
      <span>⌨️ 키보드 단축키</span>
      <button class="shortcuts-help-close" onclick="toggleShortcutsHelp()">×</button>
    </div>
    <div class="shortcut-item">
      <span class="shortcut-desc">새 작업 추가</span>
      <span class="shortcut-key">Ctrl+N</span>
    </div>
    <div class="shortcut-item">
      <span class="shortcut-desc">검색</span>
      <span class="shortcut-key">Ctrl+F</span>
    </div>
    <div class="shortcut-item">
      <span class="shortcut-desc">Next Action 완료</span>
      <span class="shortcut-key">Ctrl+D</span>
    </div>
    <div class="shortcut-item">
      <span class="shortcut-desc">실행 탭</span>
      <span class="shortcut-key">1</span>
    </div>
    <div class="shortcut-item">
      <span class="shortcut-desc">일정 탭</span>
      <span class="shortcut-key">2</span>
    </div>
    <div class="shortcut-item">
      <span class="shortcut-desc">대시보드 탭</span>
      <span class="shortcut-key">3</span>
    </div>
    <div class="shortcut-item">
      <span class="shortcut-desc">셔틀 토글</span>
      <span class="shortcut-key">S</span>
    </div>
    <div class="shortcut-item">
      <span class="shortcut-desc">도움말</span>
      <span class="shortcut-key">?</span>
    </div>
  </div>

  <script>
    // ============================================
    // 앱 상태 관리
    // ============================================
    const appState = {
      currentTab: 'action',           // 현재 활성 탭
      shuttleSuccess: false,          // 셔틀 탑승 여부
      tasks: [],                      // 모든 작업 목록
      showDetailedAdd: false,         // 상세 추가 폼 표시 여부
      showTaskList: true,             // 작업 리스트 표시 여부
      showCompletedTasks: false,      // 완료된 작업 표시 여부
      quickAddValue: '',              // 빠른 추가 입력값
      detailedTask: {                 // 상세 추가/수정용 임시 데이터
        title: '',
        category: '부업',
        deadline: '',
        estimatedTime: 10,
        link: '',
        expectedRevenue: '',
        repeatType: 'none',           // 반복 유형: none/daily/weekdays/weekends/weekly/custom/monthly
        repeatDays: [],               // 특정 요일 반복 시 요일 배열 (0=일, 1=월, ... 6=토)
        repeatMonthDay: null,         // 매월 반복 시 날짜 (1~31)
        organizer: '',                // 주최자 (부업용): 불개미, 코같투, 맨틀 등
        eventType: '',                // 이벤트 종류 (부업용): 의견작성, 리캡, AMA 등
        tags: [],                     // 태그 목록
        subtasks: []                  // 서브태스크 목록
      },
      availableTags: ['긴급', '회의', '전화', '외출', '대기중', '검토필요'],  // 사용 가능한 태그
      editingTaskId: null,            // 수정 중인 작업 ID (null이면 새로 추가)
      touchStart: null,               // 스와이프 시작 지점
      touchingTaskId: null,           // 스와이프 중인 작업 ID
      notificationPermission: 'default', // 알림 권한 상태
      scheduleFilter: 'all',          // 일정 필터: all/weekday/weekend/today
      searchQuery: '',                // 검색어
      categoryFilter: 'all',          // 카테고리 필터: all/본업/부업/일상/가족
      tagFilter: null,                 // 태그 필터: null이면 전체
      showCompletedByCategory: {},     // 전체 탭에서 카테고리별 완료 작업 표시 여부
      theme: 'dark',                   // 테마: dark/light
      draggedTaskId: null,             // 드래그 중인 작업 ID
      focusMode: false,                // 포커스 모드 (한 번에 하나만)
      streak: {                        // 연속 달성 기록
        current: 0,
        best: 0,
        lastActiveDate: null
      },
      showOnboarding: false,           // 온보딩 모달 표시
      // 포모도로 상태
      pomodoro: {
        isRunning: false,
        isBreak: false,
        timeLeft: 25 * 60,            // 25분 (초)
        workDuration: 25 * 60,        // 작업 시간
        breakDuration: 5 * 60,        // 휴식 시간
        completedPomodoros: 0,        // 완료한 포모도로 수
        currentTaskId: null           // 현재 작업 중인 태스크
      },
      // 오늘의 진행 상황
      todayStats: {
        completedToday: 0,            // 오늘 완료한 작업 수
        streak: 0,                    // 연속 완료 (세션 내)
        lastCompletedDate: null       // 마지막 완료 날짜
      },
      // 히스토리/캘린더 상태
      historyState: {
        viewingYear: new Date().getFullYear(),
        viewingMonth: new Date().getMonth(),
        selectedDate: null,           // 선택된 날짜 (YYYY-MM-DD)
        expandedDates: {}             // 펼쳐진 날짜 그룹
      },
      // 사용자 설정
      settings: {
        targetWakeTime: '07:00',      // 목표 기상 시간
        targetBedtime: '23:00',       // 목표 취침 시간
        workStartTime: '11:00',       // 출근 시간 (회사 모드 시작)
        workEndTime: '20:00',         // 퇴근 시간 (회사 모드 끝)
        dailyGoal: 5,                 // 일일 목표 (완료 작업 수)
        weeklyGoal: 25,               // 주간 목표 (완료 작업 수)
        bedtimeReminder: true,        // 취침 알림 활성화
        bedtimeReminderMinutes: 30    // 취침 몇 분 전 알림
      },
      templates: [],                    // 작업 템플릿 목록
      showSettings: false,             // 설정 모달 표시
      hideSwipeHint: false,            // 스와이프 힌트 숨기기
      // ADHD 특화 기능
      quickTimer: {
        isRunning: false,
        timeLeft: 5 * 60,              // 5분 (초)
        taskId: null                    // 타이머와 연결된 작업 ID
      },
      showCelebration: false,          // 축하 효과 표시
      lastMotivation: '',              // 마지막 동기부여 메시지
      // Firebase 동기화
      user: null,                       // 로그인한 사용자
      syncStatus: 'offline',            // 동기화 상태: offline/syncing/synced/error
      lastSyncTime: null                // 마지막 동기화 시간
    };

    // ============================================
    // 로컬스토리지 관리
    // ============================================
    
    /**
     * 로컬스토리지에서 데이터 로드
     * 에러 처리 포함
     */
    function loadState() {
      try {
        const savedTasks = localStorage.getItem('navigator-tasks');
        const isFirstVisit = !savedTasks && !localStorage.getItem('navigator-visited');

        if (savedTasks) {
          appState.tasks = JSON.parse(savedTasks);
        }

        const savedShuttle = localStorage.getItem('navigator-shuttle');
        if (savedShuttle) {
          appState.shuttleSuccess = JSON.parse(savedShuttle);
        }

        // 테마 로드
        const savedTheme = localStorage.getItem('navigator-theme');
        if (savedTheme) {
          appState.theme = savedTheme;
        }
        applyTheme();

        // 태그 로드
        const savedTags = localStorage.getItem('navigator-tags');
        if (savedTags) {
          appState.availableTags = JSON.parse(savedTags);
        }

        // 스트릭 로드
        const savedStreak = localStorage.getItem('navigator-streak');
        if (savedStreak) {
          appState.streak = JSON.parse(savedStreak);
        }
        updateStreak();

        // 설정 로드
        const savedSettings = localStorage.getItem('navigator-settings');
        if (savedSettings) {
          appState.settings = { ...appState.settings, ...JSON.parse(savedSettings) };
        }

        // 템플릿 로드
        const savedTemplates = localStorage.getItem('navigator-templates');
        if (savedTemplates) {
          appState.templates = JSON.parse(savedTemplates);
        }

        // 오늘 완료한 작업 수 계산
        const today = new Date().toDateString();
        appState.todayStats.completedToday = appState.tasks.filter(t => {
          if (!t.completed || !t.completedAt) return false;
          return new Date(t.completedAt).toDateString() === today;
        }).length;

        // 첫 방문 시 온보딩
        if (isFirstVisit) {
          setTimeout(() => showOnboarding(), 500);
        }

        // 백업 리마인더 체크
        checkBackupReminder();

      } catch (error) {
        console.error('데이터 로드 실패:', error);
        showToast('데이터 로드 중 오류가 발생했습니다', 'error');
      }
    }

    /**
     * 로컬스토리지에 데이터 저장
     * 에러 처리 포함
     */
    function saveState() {
      try {
        localStorage.setItem('navigator-tasks', JSON.stringify(appState.tasks));
        localStorage.setItem('navigator-shuttle', JSON.stringify(appState.shuttleSuccess));
        localStorage.setItem('navigator-theme', appState.theme);
        localStorage.setItem('navigator-tags', JSON.stringify(appState.availableTags));
        localStorage.setItem('navigator-settings', JSON.stringify(appState.settings));

        // Firebase 동기화 (로그인된 경우)
        if (appState.user) {
          syncToFirebase();
        }
      } catch (error) {
        console.error('데이터 저장 실패:', error);
        showToast('데이터 저장 중 오류가 발생했습니다', 'error');
      }
    }

    // ============================================
    // Firebase 동기화
    // ============================================

    let unsubscribeSnapshot = null;
    let isSyncing = false;

    /**
     * Google 로그인
     */
    async function loginWithGoogle() {
      try {
        if (!window.firebaseAuth) {
          showToast('Firebase 로딩 중...', 'info');
          return;
        }
        const result = await window.firebaseSignIn(window.firebaseAuth, window.firebaseProvider);
        appState.user = {
          uid: result.user.uid,
          email: result.user.email,
          displayName: result.user.displayName,
          photoURL: result.user.photoURL
        };
        showToast('로그인 성공! 동기화를 시작합니다', 'success');

        // 클라우드 데이터 가져오기
        await loadFromFirebase();

        // 실시간 동기화 시작
        startRealtimeSync();

        renderStatic();
      } catch (error) {
        console.error('로그인 실패:', error);
        showToast('로그인에 실패했습니다', 'error');
      }
    }
    window.loginWithGoogle = loginWithGoogle;

    /**
     * 로그아웃
     */
    async function logout() {
      try {
        await window.firebaseSignOut(window.firebaseAuth);
        appState.user = null;
        appState.syncStatus = 'offline';

        // 실시간 동기화 중지
        if (unsubscribeSnapshot) {
          unsubscribeSnapshot();
          unsubscribeSnapshot = null;
        }

        showToast('로그아웃되었습니다', 'info');
        renderStatic();
      } catch (error) {
        console.error('로그아웃 실패:', error);
      }
    }
    window.logout = logout;

    /**
     * Firebase에 데이터 저장
     */
    async function syncToFirebase() {
      if (!appState.user || isSyncing) return;

      try {
        isSyncing = true;
        appState.syncStatus = 'syncing';

        const userDoc = window.firebaseDoc(window.firebaseDb, 'users', appState.user.uid);
        await window.firebaseSetDoc(userDoc, {
          tasks: appState.tasks,
          settings: appState.settings,
          streak: appState.streak,
          templates: appState.templates,
          availableTags: appState.availableTags,
          lastUpdated: new Date().toISOString()
        });

        appState.syncStatus = 'synced';
        appState.lastSyncTime = new Date();
        updateSyncIndicator();
      } catch (error) {
        console.error('동기화 실패:', error);
        appState.syncStatus = 'error';
        updateSyncIndicator();
      } finally {
        isSyncing = false;
      }
    }

    /**
     * Firebase에서 데이터 로드
     */
    async function loadFromFirebase() {
      if (!appState.user) return;

      try {
        appState.syncStatus = 'syncing';
        const userDoc = window.firebaseDoc(window.firebaseDb, 'users', appState.user.uid);
        const docSnap = await window.firebaseGetDoc(userDoc);

        if (docSnap.exists()) {
          const data = docSnap.data();

          // 클라우드 데이터가 더 최신이면 로드
          const cloudTasks = data.tasks || [];
          const localTasks = appState.tasks || [];

          // 병합: 클라우드 데이터로 교체 (더 많은 데이터 기준)
          if (cloudTasks.length > 0) {
            // 로컬에만 있는 새 작업 보존
            const cloudIds = new Set(cloudTasks.map(t => t.id));
            const localOnlyTasks = localTasks.filter(t => !cloudIds.has(t.id));

            appState.tasks = [...cloudTasks, ...localOnlyTasks];
          }

          if (data.settings) {
            appState.settings = { ...appState.settings, ...data.settings };
          }
          if (data.streak) {
            appState.streak = data.streak;
          }
          if (data.templates) {
            appState.templates = data.templates;
          }
          if (data.availableTags) {
            appState.availableTags = data.availableTags;
          }

          // 로컬에도 저장
          localStorage.setItem('navigator-tasks', JSON.stringify(appState.tasks));
          localStorage.setItem('navigator-settings', JSON.stringify(appState.settings));

          appState.syncStatus = 'synced';
        } else {
          // 클라우드에 데이터 없으면 현재 로컬 데이터 업로드
          await syncToFirebase();
        }

        appState.lastSyncTime = new Date();
        updateSyncIndicator();
      } catch (error) {
        console.error('데이터 로드 실패:', error);
        appState.syncStatus = 'error';
      }
    }

    /**
     * 실시간 동기화 시작
     */
    function startRealtimeSync() {
      if (!appState.user || unsubscribeSnapshot) return;

      const userDoc = window.firebaseDoc(window.firebaseDb, 'users', appState.user.uid);
      unsubscribeSnapshot = window.firebaseOnSnapshot(userDoc, (doc) => {
        if (doc.exists() && !isSyncing) {
          const data = doc.data();
          const cloudUpdated = new Date(data.lastUpdated);
          const localUpdated = appState.lastSyncTime;

          // 클라우드가 더 최신이면 업데이트
          if (!localUpdated || cloudUpdated > localUpdated) {
            if (data.tasks) {
              appState.tasks = data.tasks;
              localStorage.setItem('navigator-tasks', JSON.stringify(appState.tasks));
            }
            if (data.settings) {
              appState.settings = { ...appState.settings, ...data.settings };
            }
            if (data.streak) {
              appState.streak = data.streak;
            }

            appState.lastSyncTime = cloudUpdated;
            appState.syncStatus = 'synced';

            // 오늘 통계 재계산
            const today = new Date().toDateString();
            appState.todayStats.completedToday = appState.tasks.filter(t => {
              if (!t.completed || !t.completedAt) return false;
              return new Date(t.completedAt).toDateString() === today;
            }).length;

            renderStatic();
            updateSyncIndicator();
          }
        }
      });
    }

    /**
     * 동기화 상태 표시 업데이트
     */
    function updateSyncIndicator() {
      const indicator = document.getElementById('sync-indicator');
      if (!indicator) return;

      const statusMap = {
        'offline': { icon: '☁️', text: '오프라인', color: '#888' },
        'syncing': { icon: '🔄', text: '동기화 중...', color: '#667eea' },
        'synced': { icon: '✅', text: '동기화됨', color: '#48bb78' },
        'error': { icon: '⚠️', text: '동기화 오류', color: '#f5576c' }
      };

      const status = statusMap[appState.syncStatus] || statusMap['offline'];
      indicator.innerHTML = status.icon + ' ' + status.text;
      indicator.style.color = status.color;
    }

    // ============================================
    // 우선순위 계산 로직
    // ============================================
    
    /**
     * 작업의 우선순위 점수 계산
     * 점수가 높을수록 우선순위 높음
     */
    function calculatePriority(task) {
      let score = 0;
      const now = new Date();
      
      // 1. 마감시간 기반 점수 (가장 중요)
      if (task.deadline) {
        const deadline = new Date(task.deadline);
        const hoursLeft = (deadline - now) / (1000 * 60 * 60);
        
        if (hoursLeft < 0) score -= 100;      // 이미 지남: 패널티
        else if (hoursLeft < 3) score += 100; // 3시간 내: 최우선
        else if (hoursLeft < 24) score += 70; // 하루 내: 높은 우선순위
        else if (hoursLeft < 72) score += 40; // 3일 내: 중간 우선순위
      }
      
      // 2. 카테고리 기본 점수
      if (task.category === '본업') score += 40;
      else if (task.category === '부업') score += 35;
      else if (task.category === '일상') score += 25;
      
      // 3. 부업의 경우 ROI 계산 (수익/시간)
      if (task.category === '부업' && task.expectedRevenue) {
        const roi = task.expectedRevenue / task.estimatedTime;
        score += Math.min(roi * 0.1, 30); // 최대 30점까지
      }
      
      // 4. 짧은 작업 우대 (빠른 성취감)
      if (task.estimatedTime <= 10) score += 10;
      
      return score;
    }

    /**
     * 작업의 긴급도 레벨 반환
     */
    function getUrgencyLevel(task) {
      if (!task.deadline) return 'normal';
      
      const now = new Date();
      const deadline = new Date(task.deadline);
      const hoursLeft = (deadline - now) / (1000 * 60 * 60);
      
      if (hoursLeft < 0) return 'expired';   // 마감 지남
      if (hoursLeft < 3) return 'urgent';    // 긴급 (빨강)
      if (hoursLeft < 24) return 'warning';  // 주의 (주황)
      return 'normal';                       // 일반
    }

    // ============================================
    // 모드 및 필터링
    // ============================================
    
    /**
     * 시간 문자열(HH:MM)을 시간(hour)으로 변환
     */
    function parseTimeToHour(timeStr) {
      const [hour] = timeStr.split(':').map(Number);
      return hour;
    }

    /**
     * 현재 시간대 기반 모드 결정
     * 설정된 시간 기준으로 계산
     */
    function getCurrentMode() {
      const now = new Date();
      const hour = now.getHours();
      const dayOfWeek = now.getDay(); // 0=일, 6=토
      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
      const settings = appState.settings;

      const workStart = parseTimeToHour(settings.workStartTime);
      const workEnd = parseTimeToHour(settings.workEndTime);
      const bedtime = parseTimeToHour(settings.targetBedtime);
      const wakeTime = parseTimeToHour(settings.targetWakeTime);

      // 주말은 휴식 모드 (단, 취침 시간 가까우면 생존 모드)
      if (isWeekend) {
        if (!appState.shuttleSuccess && hour >= bedtime - 2 && hour < bedtime + 1) return '생존';
        return '주말';
      }

      // 회사 시간 (평일만)
      if (hour >= workStart && hour < workEnd) return '회사';

      // 셔틀 성공 시 여유 모드 (퇴근 후 ~ 취침)
      if (appState.shuttleSuccess && hour >= workEnd - 1 && hour < bedtime) return '여유';

      // 셔틀 실패 시 생존 모드 (취침 2시간 전부터)
      if (!appState.shuttleSuccess && hour >= bedtime - 2 && hour < bedtime + 1) return '생존';

      // 출근 전 시간 (기상 ~ 회사 시작)
      if (hour >= wakeTime && hour < workStart) return '출근';

      // 그 외는 휴식
      return '휴식';
    }

    /**
     * 모드별 시간 레이블 반환
     */
    function getModeTimeLabel(mode, hour) {
      switch(mode) {
        case '회사': return '퇴근까지';
        case '여유': return '취침까지';
        case '생존': return '취침까지';
        case '출근': return '출근까지';
        case '주말': return '오늘 남은 시간';
        case '휴식': return '기상까지';
        default: return '남은 시간';
      }
    }

    /**
     * 모드별 남은 시간 계산 (설정 기반)
     */
    function getModeTimeRemaining(mode, hour, now) {
      const settings = appState.settings;
      const workEnd = parseTimeToHour(settings.workEndTime);
      const bedtime = parseTimeToHour(settings.targetBedtime);
      const wakeTime = parseTimeToHour(settings.targetWakeTime);
      const workStart = parseTimeToHour(settings.workStartTime);

      let endHour;
      switch(mode) {
        case '회사': endHour = workEnd; break;
        case '여유': endHour = bedtime; break;
        case '생존': endHour = bedtime; break;
        case '출근': endHour = workStart; break;
        case '주말': endHour = bedtime; break;
        case '휴식': endHour = wakeTime; break;
        default: endHour = 24;
      }

      let hoursLeft, minutesLeft;

      // 휴식 모드: 기상 시간까지 계산
      if (mode === '휴식') {
        if (hour >= 0 && hour < wakeTime) {
          // 자정 이후 ~ 기상시간 전
          hoursLeft = wakeTime - hour - 1;
          minutesLeft = 60 - now.getMinutes();
          if (minutesLeft === 60) { minutesLeft = 0; hoursLeft++; }
        } else {
          // 자정 이전
          hoursLeft = (24 - hour) + wakeTime - 1;
          minutesLeft = 60 - now.getMinutes();
          if (minutesLeft === 60) { minutesLeft = 0; hoursLeft++; }
        }
      } else {
        hoursLeft = endHour - hour - 1;
        minutesLeft = 60 - now.getMinutes();
        if (minutesLeft === 60) { minutesLeft = 0; hoursLeft++; }
      }

      if (hoursLeft < 0) hoursLeft = 0;
      if (minutesLeft < 0) minutesLeft = 0;

      return `${hoursLeft}시간 ${minutesLeft}분`;
    }

    /**
     * 현재 모드에 맞게 작업 필터링 및 정렬
     */
    function getFilteredTasks() {
      const mode = getCurrentMode();
      let filtered = appState.tasks.filter(t => !t.completed);

      // 우선순위와 긴급도 계산
      filtered = filtered.map(t => ({
        ...t,
        priority: calculatePriority(t),
        urgency: getUrgencyLevel(t)
      }));

      // 우선순위 기준 정렬 (높은 순)
      filtered.sort((a, b) => b.priority - a.priority);

      // 모드별 필터링
      if (mode === '회사') {
        filtered = filtered.filter(t => t.category === '본업');
      } else if (mode === '생존') {
        // 생존 모드: 짧고 긴급한 것만
        filtered = filtered.filter(t => t.estimatedTime <= 15 || t.priority > 90);
      }

      // 검색 및 카테고리 필터 적용
      filtered = getSearchFilteredTasks(filtered);

      return filtered;
    }

    /**
     * 카테고리별 통계 계산
     */
    function getCategoryStats() {
      const categories = ['본업', '부업', '일상'];
      return categories.map(cat => {
        const allTasks = appState.tasks.filter(t => t.category === cat);
        const completed = allTasks.filter(t => t.completed).length;
        const total = allTasks.length;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        return { 
          category: cat, 
          total: total - completed,  // 남은 작업
          completed, 
          percentage 
        };
      });
    }

    /**
     * 긴급 작업 목록 반환
     */
    function getUrgentTasks() {
      return appState.tasks
        .filter(t => !t.completed && t.deadline)
        .map(t => ({
          ...t,
          urgency: getUrgencyLevel(t)
        }))
        .filter(t => t.urgency === 'urgent' || t.urgency === 'warning')
        .sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
    }

    // ============================================
    // 데이터 인사이트 함수
    // ============================================

    /**
     * 시간대별 생산성 분석
     */
    function getHourlyProductivity() {
      const hourlyData = {};
      for (let i = 0; i < 24; i++) {
        hourlyData[i] = 0;
      }

      appState.tasks.filter(t => t.completed && t.completedAt).forEach(task => {
        const hour = new Date(task.completedAt).getHours();
        hourlyData[hour]++;
      });

      // 가장 생산적인 시간대 찾기
      let maxHour = 0;
      let maxCount = 0;
      for (let i = 0; i < 24; i++) {
        if (hourlyData[i] > maxCount) {
          maxCount = hourlyData[i];
          maxHour = i;
        }
      }

      // 시간대별 그룹화 (아침/점심/오후/저녁/밤)
      const periods = {
        morning: { name: '아침 (6-11시)', count: 0, hours: [6, 7, 8, 9, 10, 11] },
        lunch: { name: '점심 (11-14시)', count: 0, hours: [11, 12, 13, 14] },
        afternoon: { name: '오후 (14-18시)', count: 0, hours: [14, 15, 16, 17, 18] },
        evening: { name: '저녁 (18-22시)', count: 0, hours: [18, 19, 20, 21, 22] },
        night: { name: '밤 (22-6시)', count: 0, hours: [22, 23, 0, 1, 2, 3, 4, 5] }
      };

      for (let i = 0; i < 24; i++) {
        if (i >= 6 && i < 11) periods.morning.count += hourlyData[i];
        else if (i >= 11 && i < 14) periods.lunch.count += hourlyData[i];
        else if (i >= 14 && i < 18) periods.afternoon.count += hourlyData[i];
        else if (i >= 18 && i < 22) periods.evening.count += hourlyData[i];
        else periods.night.count += hourlyData[i];
      }

      // 가장 생산적인 시간대
      let bestPeriod = 'morning';
      let bestCount = 0;
      Object.keys(periods).forEach(key => {
        if (periods[key].count > bestCount) {
          bestCount = periods[key].count;
          bestPeriod = key;
        }
      });

      return {
        hourlyData,
        peakHour: maxHour,
        peakCount: maxCount,
        periods,
        bestPeriod: periods[bestPeriod],
        totalCompleted: Object.values(hourlyData).reduce((a, b) => a + b, 0)
      };
    }

    /**
     * 카테고리별 완료 분배
     */
    function getCategoryDistribution() {
      const completed = appState.tasks.filter(t => t.completed);
      const distribution = {};

      completed.forEach(task => {
        const cat = task.category || '기타';
        distribution[cat] = (distribution[cat] || 0) + 1;
      });

      const total = completed.length;
      const result = Object.keys(distribution).map(cat => ({
        category: cat,
        count: distribution[cat],
        percentage: total > 0 ? Math.round((distribution[cat] / total) * 100) : 0
      })).sort((a, b) => b.count - a.count);

      return { distribution: result, total };
    }

    /**
     * 요일별 생산성 분석
     */
    function getDayOfWeekProductivity() {
      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      const dayData = [0, 0, 0, 0, 0, 0, 0];

      appState.tasks.filter(t => t.completed && t.completedAt).forEach(task => {
        const day = new Date(task.completedAt).getDay();
        dayData[day]++;
      });

      const maxDay = dayData.indexOf(Math.max(...dayData));

      return {
        data: dayNames.map((name, i) => ({ name, count: dayData[i] })),
        bestDay: dayNames[maxDay],
        bestDayCount: dayData[maxDay]
      };
    }

    // ============================================
    // 히스토리 / 캘린더 관련 함수
    // ============================================

    /**
     * 특정 날짜의 완료된 작업 목록 가져오기
     */
    function getCompletedTasksByDate(dateStr) {
      return appState.tasks.filter(t => {
        if (!t.completed || !t.completedAt) return false;
        const completedDate = new Date(t.completedAt).toLocaleDateString('ko-KR');
        const targetDate = new Date(dateStr).toLocaleDateString('ko-KR');
        return completedDate === targetDate;
      }).sort((a, b) => new Date(a.completedAt) - new Date(b.completedAt));
    }

    /**
     * 날짜별 완료 작업 수 맵 생성
     */
    function getCompletionMap() {
      const map = {};
      appState.tasks.forEach(t => {
        if (t.completed && t.completedAt) {
          const dateKey = new Date(t.completedAt).toISOString().split('T')[0];
          map[dateKey] = (map[dateKey] || 0) + 1;
        }
      });
      return map;
    }

    /**
     * 주간 통계 계산
     */
    function getWeeklyStats() {
      const now = new Date();
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay()); // 이번 주 일요일
      weekStart.setHours(0, 0, 0, 0);

      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 7);

      const completedThisWeek = appState.tasks.filter(t => {
        if (!t.completed || !t.completedAt) return false;
        const completedDate = new Date(t.completedAt);
        return completedDate >= weekStart && completedDate < weekEnd;
      });

      // 일별 완료 수 계산
      const dailyCounts = [];
      for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(weekStart.getDate() + i);
        const dayStr = day.toISOString().split('T')[0];
        const count = completedThisWeek.filter(t =>
          new Date(t.completedAt).toISOString().split('T')[0] === dayStr
        ).length;
        dailyCounts.push(count);
      }

      const totalCompleted = completedThisWeek.length;
      const daysWithActivity = dailyCounts.filter(c => c > 0).length;
      const avgPerDay = daysWithActivity > 0 ? (totalCompleted / daysWithActivity).toFixed(1) : 0;

      return {
        total: totalCompleted,
        avgPerDay: avgPerDay,
        activeDays: daysWithActivity,
        dailyCounts: dailyCounts
      };
    }

    /**
     * 캘린더 이전 달로 이동
     */
    function prevMonth() {
      appState.historyState.viewingMonth--;
      if (appState.historyState.viewingMonth < 0) {
        appState.historyState.viewingMonth = 11;
        appState.historyState.viewingYear--;
      }
      appState.historyState.selectedDate = null;
      renderStatic();
    }

    /**
     * 캘린더 다음 달로 이동
     */
    function nextMonth() {
      appState.historyState.viewingMonth++;
      if (appState.historyState.viewingMonth > 11) {
        appState.historyState.viewingMonth = 0;
        appState.historyState.viewingYear++;
      }
      appState.historyState.selectedDate = null;
      renderStatic();
    }

    /**
     * 캘린더에서 날짜 선택
     */
    function selectDate(dateStr) {
      if (appState.historyState.selectedDate === dateStr) {
        appState.historyState.selectedDate = null;
      } else {
        appState.historyState.selectedDate = dateStr;
      }
      renderStatic();
    }

    /**
     * 히스토리에서 날짜 그룹 토글
     */
    function toggleHistoryDate(dateStr) {
      appState.historyState.expandedDates[dateStr] = !appState.historyState.expandedDates[dateStr];
      renderStatic();
    }

    /**
     * 캘린더 렌더링 HTML 생성
     */
    function renderCalendar() {
      const year = appState.historyState.viewingYear;
      const month = appState.historyState.viewingMonth;
      const completionMap = getCompletionMap();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDayOfWeek = firstDay.getDay();

      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월',
                          '7월', '8월', '9월', '10월', '11월', '12월'];

      let daysHtml = '';

      // 빈 칸 (이전 달)
      for (let i = 0; i < startDayOfWeek; i++) {
        daysHtml += '<div class="calendar-day empty"></div>';
      }

      // 날짜 칸
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const count = completionMap[dateStr] || 0;
        const isToday = dateStr === todayStr;
        const isSelected = dateStr === appState.historyState.selectedDate;

        // 활동 레벨 (1-4)
        let level = 0;
        if (count > 0) level = 1;
        if (count >= 3) level = 2;
        if (count >= 5) level = 3;
        if (count >= 7) level = 4;

        const classes = [
          'calendar-day',
          isToday ? 'today' : '',
          isSelected ? 'selected' : '',
          count > 0 ? 'has-activity' : '',
          count > 0 ? `level-${level}` : ''
        ].filter(Boolean).join(' ');

        daysHtml += `
          <div class="${classes}" onclick="selectDate('${dateStr}')">
            <span class="calendar-day-number">${day}</span>
            ${count > 0 ? '<span class="calendar-day-dot"></span>' : ''}
          </div>
        `;
      }

      return `
        <div class="calendar-container">
          <div class="calendar-header">
            <div class="calendar-title">${year}년 ${monthNames[month]}</div>
            <div class="calendar-nav">
              <button class="calendar-nav-btn" onclick="prevMonth()">◀</button>
              <button class="calendar-nav-btn" onclick="nextMonth()">▶</button>
            </div>
          </div>
          <div class="calendar-weekdays">
            <div class="calendar-weekday">일</div>
            <div class="calendar-weekday">월</div>
            <div class="calendar-weekday">화</div>
            <div class="calendar-weekday">수</div>
            <div class="calendar-weekday">목</div>
            <div class="calendar-weekday">금</div>
            <div class="calendar-weekday">토</div>
          </div>
          <div class="calendar-days">
            ${daysHtml}
          </div>
          <div class="calendar-legend">
            <div class="legend-item"><div class="legend-box empty"></div>없음</div>
            <div class="legend-item"><div class="legend-box level-1"></div>1-2개</div>
            <div class="legend-item"><div class="legend-box level-2"></div>3-4개</div>
            <div class="legend-item"><div class="legend-box level-3"></div>5-6개</div>
            <div class="legend-item"><div class="legend-box level-4"></div>7+개</div>
          </div>
        </div>
      `;
    }

    /**
     * 선택된 날짜의 상세 정보 렌더링
     */
    function renderDayDetail() {
      const selectedDate = appState.historyState.selectedDate;
      if (!selectedDate) return '';

      const tasks = getCompletedTasksByDate(selectedDate);
      const date = new Date(selectedDate);
      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      const dateTitle = `${date.getMonth() + 1}월 ${date.getDate()}일 ${dayNames[date.getDay()]}요일`;

      // 총 소요 시간 계산
      const totalTime = tasks.reduce((sum, t) => sum + (t.estimatedTime || 0), 0);

      return `
        <div class="day-detail">
          <div class="day-detail-header">
            <div class="day-detail-date">${dateTitle}</div>
            <div class="day-detail-stats">
              <div class="day-detail-stat completed">✓ ${tasks.length}개 완료</div>
              ${totalTime > 0 ? `<div class="day-detail-stat">⏱ ${totalTime}분</div>` : ''}
            </div>
          </div>
          ${tasks.length > 0 ? `
            <div class="day-detail-list">
              ${tasks.map(task => {
                const completedTime = new Date(task.completedAt);
                const timeStr = completedTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                return `
                  <div class="day-task-item">
                    <div class="day-task-time">${timeStr}</div>
                    <div class="day-task-content">
                      <div class="day-task-title completed">${task.title}</div>
                      <div class="day-task-meta">
                        <span class="category ${task.category}">${task.category}</span>
                        ${task.estimatedTime ? ` · ${task.estimatedTime}분` : ''}
                      </div>
                    </div>
                    <div class="day-task-status">✅</div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : `
            <div class="day-empty">
              <div class="day-empty-icon">📭</div>
              <div>이 날 완료한 작업이 없습니다</div>
            </div>
          `}
        </div>
      `;
    }

    /**
     * 최근 기록 리스트 렌더링
     */
    function renderRecentHistory() {
      // 완료된 작업을 날짜별로 그룹화
      const completedTasks = appState.tasks.filter(t => t.completed && t.completedAt);
      if (completedTasks.length === 0) {
        return `
          <div class="day-empty">
            <div class="day-empty-icon">📝</div>
            <div>아직 완료한 작업이 없습니다</div>
            <div style="margin-top: 10px; font-size: 14px; color: var(--text-secondary);">
              작업을 완료하면 여기에 기록됩니다
            </div>
          </div>
        `;
      }

      // 날짜별 그룹화
      const grouped = {};
      completedTasks.forEach(t => {
        const dateKey = new Date(t.completedAt).toISOString().split('T')[0];
        if (!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push(t);
      });

      // 최근 날짜순 정렬
      const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
      const recentDates = sortedDates.slice(0, 14); // 최근 14일

      return `
        <div class="history-list">
          ${recentDates.map(dateStr => {
            const tasks = grouped[dateStr].sort((a, b) =>
              new Date(a.completedAt) - new Date(b.completedAt)
            );
            const date = new Date(dateStr);
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            const isToday = dateStr === new Date().toISOString().split('T')[0];
            const isYesterday = dateStr === new Date(Date.now() - 86400000).toISOString().split('T')[0];

            let dateTitle;
            if (isToday) dateTitle = '오늘';
            else if (isYesterday) dateTitle = '어제';
            else dateTitle = `${date.getMonth() + 1}월 ${date.getDate()}일 (${dayNames[date.getDay()]})`;

            const isExpanded = appState.historyState.expandedDates[dateStr];

            return `
              <div class="history-date-group">
                <div class="history-date-header" onclick="toggleHistoryDate('${dateStr}')">
                  <div class="history-date-title">${dateTitle}</div>
                  <div class="history-date-count">✓ ${tasks.length}개 완료 ${isExpanded ? '▲' : '▼'}</div>
                </div>
                <div class="history-date-tasks ${isExpanded ? 'show' : ''}">
                  ${tasks.map(task => {
                    const time = new Date(task.completedAt).toLocaleTimeString('ko-KR', {
                      hour: '2-digit', minute: '2-digit'
                    });
                    return `
                      <div class="history-task">
                        <span class="history-task-check">✓</span>
                        <span class="history-task-title">${task.title}</span>
                        <span class="history-task-time">${time}</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // ============================================
    // 사용자 액션 핸들러
    // ============================================
    
    /**
     * 탭 전환
     */
    function switchTab(tab) {
      appState.currentTab = tab;
      renderStatic();
    }

    /**
     * 테마 전환
     */
    function toggleTheme() {
      appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', appState.theme);
      saveState();
      renderStatic();
    }

    /**
     * 테마 적용 (페이지 로드 시)
     */
    function applyTheme() {
      document.body.setAttribute('data-theme', appState.theme);
    }

    /**
     * 설정 모달 열기
     */
    function openSettings() {
      appState.showSettings = true;
      renderStatic();
    }

    /**
     * 설정 모달 닫기
     */
    function closeSettings() {
      appState.showSettings = false;
      renderStatic();
    }

    /**
     * 개별 설정 업데이트
     */
    function updateSetting(key, value) {
      appState.settings[key] = value;
      saveState();
      renderStatic();
    }

    // ============================================
    // 템플릿 관리
    // ============================================

    /**
     * 현재 작업을 템플릿으로 저장
     */
    function saveAsTemplate(task) {
      const template = {
        id: Date.now(),
        title: task.title,
        category: task.category,
        estimatedTime: task.estimatedTime,
        tags: task.tags || [],
        icon: getCategoryIcon(task.category)
      };

      appState.templates.push(template);
      saveTemplates();
      showToast('템플릿으로 저장되었습니다', 'success');
      renderStatic();
    }

    /**
     * 카테고리별 아이콘 반환
     */
    function getCategoryIcon(category) {
      switch(category) {
        case '본업': return '💼';
        case '부업': return '💰';
        case '일상': return '🏠';
        case '가족': return '👨‍👩‍👧';
        default: return '📌';
      }
    }

    /**
     * 템플릿 삭제
     */
    function deleteTemplate(templateId) {
      appState.templates = appState.templates.filter(t => t.id !== templateId);
      saveTemplates();
      renderStatic();
    }

    /**
     * 템플릿으로 작업 추가
     */
    function addFromTemplate(templateId) {
      const template = appState.templates.find(t => t.id === templateId);
      if (!template) return;

      appState.tasks.push({
        id: Date.now(),
        title: template.title,
        category: template.category,
        deadline: '',
        estimatedTime: template.estimatedTime,
        link: '',
        expectedRevenue: '',
        tags: template.tags || [],
        completed: false,
        createdAt: new Date().toISOString()
      });

      saveState();
      renderStatic();
      showToast(`"${template.title}" 추가됨`, 'success');

      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    /**
     * 빠른 추가에서 템플릿 저장
     */
    function saveCurrentAsTemplate() {
      const title = appState.quickAddValue.trim();
      if (!title) {
        showToast('제목을 먼저 입력하세요', 'error');
        return;
      }

      const template = {
        id: Date.now(),
        title: title,
        category: '부업',
        estimatedTime: 10,
        tags: [],
        icon: '💰'
      };

      appState.templates.push(template);
      saveTemplates();
      appState.quickAddValue = '';
      const input = document.getElementById('quick-add-input');
      if (input) input.value = '';

      showToast('템플릿으로 저장됨', 'success');
      renderStatic();
    }

    /**
     * 템플릿 저장 (localStorage)
     */
    function saveTemplates() {
      try {
        localStorage.setItem('navigator-templates', JSON.stringify(appState.templates));
      } catch (e) {
        console.error('템플릿 저장 실패:', e);
      }
    }

    /**
     * 템플릿 로드 (localStorage)
     */
    function loadTemplates() {
      try {
        const saved = localStorage.getItem('navigator-templates');
        if (saved) {
          appState.templates = JSON.parse(saved);
        }
      } catch (e) {
        console.error('템플릿 로드 실패:', e);
        appState.templates = [];
      }
    }

    /**
     * 부업 이벤트 추가 (부업 탭에서 호출)
     */
    function addNewEvent() {
      appState.detailedTask = {
        title: '',
        category: '부업',
        deadline: '',
        estimatedTime: 10,
        link: '',
        expectedRevenue: '',
        repeatType: 'none',
        repeatDays: [],
        repeatMonthDay: null,
        organizer: '',
        eventType: '',
        tags: [],
        subtasks: []
      };
      appState.showDetailedAdd = true;
      appState.editingTaskId = null;
      appState.currentTab = 'action';
      renderStatic();
      // 폼으로 스크롤
      setTimeout(() => {
        const form = document.querySelector('.detailed-add');
        if (form) form.scrollIntoView({ behavior: 'smooth' });
      }, 100);
    }

    /**
     * 셔틀 상태 토글
     */
    function toggleShuttle() {
      appState.shuttleSuccess = !appState.shuttleSuccess;
      saveState();
      renderStatic();
    }

    /**
     * 빠른 추가 (제목만 입력)
     */
    function quickAdd() {
      const title = appState.quickAddValue.trim();
      if (!title) {
        showToast('제목을 입력하세요', 'error');
        return;
      }
      
      appState.tasks.push({
        id: Date.now(),
        title: title,
        category: '부업',
        deadline: '',
        estimatedTime: 10,
        link: '',
        expectedRevenue: '',
        completed: false,
        createdAt: new Date().toISOString()
      });
      
      appState.quickAddValue = '';
      const input = document.getElementById('quick-add-input');
      if (input) input.value = '';
      
      saveState();
      renderStatic();
      showToast('작업이 추가되었습니다', 'success');
      
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    /**
     * 상세 추가/수정
     */
    function detailedAdd() {
      const task = appState.detailedTask;
      if (!task.title) {
        showToast('제목을 입력하세요', 'error');
        return;
      }
      
      if (appState.editingTaskId) {
        // 수정 모드
        appState.tasks = appState.tasks.map(t => 
          t.id === appState.editingTaskId 
            ? { ...task, id: t.id, completed: t.completed, createdAt: t.createdAt }
            : t
        );
        showToast('작업이 수정되었습니다', 'success');
      } else {
        // 추가 모드
        appState.tasks.push({
          id: Date.now(),
          ...task,
          completed: false,
          createdAt: new Date().toISOString()
        });
        showToast('작업이 추가되었습니다', 'success');
      }
      
      // 폼 초기화
      appState.detailedTask = {
        title: '',
        category: '부업',
        deadline: '',
        estimatedTime: 10,
        link: '',
        expectedRevenue: '',
        repeatType: 'none',
        repeatDays: [],
        repeatMonthDay: null,
        organizer: '',
        eventType: '',
        tags: [],
        subtasks: []
      };
      appState.showDetailedAdd = false;
      appState.editingTaskId = null;

      saveState();
      renderStatic();

      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    /**
     * 작업 완료
     * 반복 작업인 경우 다음 주기로 새 작업 생성
     */
    function completeTask(id) {
      const task = appState.tasks.find(t => t.id === id);
      if (!task) return;

      // 완료 처리
      appState.tasks = appState.tasks.map(t =>
        t.id === id ? { ...t, completed: true, completedAt: new Date().toISOString() } : t
      );

      // 오늘 통계 업데이트
      appState.todayStats.completedToday++;
      appState.todayStats.streak++;

      // 스트릭 기록
      recordActivity();

      // 반복 작업이면 다음 주기 작업 자동 생성
      if (task.repeatType && task.repeatType !== 'none') {
        const nextTask = createNextRepeatTask(task);
        if (nextTask) {
          appState.tasks.push(nextTask);
        }
      }

      saveState();

      // 완료 애니메이션 표시
      showCompletionAnimation(task.title, appState.todayStats.streak);

      // 마일스톤 체크 (ADHD 특화 - 도파민 보상)
      checkMilestone();

      if (navigator.vibrate) {
        navigator.vibrate([50, 100, 50]);
      }
    }

    /**
     * 완료 애니메이션 표시
     */
    function showCompletionAnimation(taskTitle, streak) {
      const overlay = document.getElementById('completion-overlay');
      const titleEl = document.getElementById('completion-task-title');
      const streakEl = document.getElementById('completion-streak');

      if (overlay) {
        if (titleEl) titleEl.textContent = taskTitle;
        if (streakEl) {
          if (streak > 1) {
            streakEl.textContent = `🔥 ${streak}연속 완료!`;
            streakEl.style.display = 'block';
          } else {
            streakEl.style.display = 'none';
          }
        }

        overlay.classList.add('show');

        setTimeout(() => {
          overlay.classList.remove('show');
          renderStatic();
        }, 1200);
      } else {
        renderStatic();
      }
    }

    // ============================================
    // ADHD 특화 기능
    // ============================================

    let quickTimerInterval = null;

    /**
     * 5분 퀵타이머 시작
     */
    function startQuickTimer(taskId = null) {
      if (appState.quickTimer.isRunning) {
        stopQuickTimer();
        return;
      }

      appState.quickTimer = {
        isRunning: true,
        timeLeft: 5 * 60,
        taskId: taskId
      };

      showMotivation('시작이 반이에요! 5분만 집중해봐요 💪');

      quickTimerInterval = setInterval(() => {
        appState.quickTimer.timeLeft--;

        if (appState.quickTimer.timeLeft <= 0) {
          stopQuickTimer();
          showMotivation('5분 완료! 계속할 수 있어요! 🎉');
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
          }
        }

        renderQuickTimerDisplay();
      }, 1000);

      renderStatic();

      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }
    window.startQuickTimer = startQuickTimer;

    /**
     * 퀵타이머 중지
     */
    function stopQuickTimer() {
      if (quickTimerInterval) {
        clearInterval(quickTimerInterval);
        quickTimerInterval = null;
      }
      appState.quickTimer.isRunning = false;
      appState.quickTimer.timeLeft = 5 * 60;
      renderStatic();
    }
    window.stopQuickTimer = stopQuickTimer;

    /**
     * 퀵타이머 디스플레이 업데이트
     */
    function renderQuickTimerDisplay() {
      const display = document.getElementById('quick-timer-display');
      if (display) {
        const mins = Math.floor(appState.quickTimer.timeLeft / 60);
        const secs = appState.quickTimer.timeLeft % 60;
        display.textContent = mins + ':' + String(secs).padStart(2, '0');
      }
    }

    /**
     * 동기부여 메시지 표시
     */
    function showMotivation(message) {
      appState.lastMotivation = message;

      // 기존 토스트 제거
      const existing = document.querySelector('.motivation-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'motivation-toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    window.showMotivation = showMotivation;

    /**
     * 축하 효과 (콘페티)
     */
    function showCelebration(emoji = '🎉') {
      appState.showCelebration = true;

      // 축하 텍스트
      const textEl = document.createElement('div');
      textEl.className = 'celebration-text';
      textEl.textContent = emoji;
      document.body.appendChild(textEl);

      // 콘페티 효과
      const overlay = document.createElement('div');
      overlay.className = 'celebration-overlay';
      const colors = ['#667eea', '#f093fb', '#4ecdc4', '#ffd93d', '#f5576c', '#48bb78'];

      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-10px';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        overlay.appendChild(confetti);
      }

      document.body.appendChild(overlay);

      setTimeout(() => {
        textEl.remove();
        overlay.remove();
        appState.showCelebration = false;
      }, 3000);
    }
    window.showCelebration = showCelebration;

    /**
     * 마일스톤 체크 및 축하
     */
    function checkMilestone() {
      const completed = appState.todayStats.completedToday;
      const dailyGoal = appState.settings.dailyGoal || 5;

      // 일일 목표 달성
      if (completed === dailyGoal) {
        showCelebration('🎯');
        showMotivation('일일 목표 달성! 대단해요! 🏆');
        return;
      }

      // 특정 개수 달성
      if (completed === 3) {
        showMotivation('좋아요! 3개 완료! 그 조자에요! 🔥');
      } else if (completed === 5) {
        showCelebration('⭐');
        showMotivation('와! 벌써 5개! 👏');
      } else if (completed === 10) {
        showCelebration('🌟');
        showMotivation('10개 달성! 오늘 진짜 열일했네요! 💪');
      } else if (completed > 0 && completed % 5 === 0) {
        showMotivation(completed + '개 완료! 계속 가보자! 🚀');
      }
    }

    /**
     * 랜덤 동기부여 메시지
     */
    function getRandomMotivation() {
      const messages = [
        '지금 시작하면 5분 뒤엔 끝나있어요!',
        '완벽하지 않아도 괜찮아요, 시작만 하면 돼요!',
        '작은 한 걸음이 큰 변화를 만들어요',
        '할 수 있어요! 일단 시작해봐요 💪',
        '오늘 할 일은 오늘! 미루면 내일의 내가 힘들어요',
        '5분만 집중! 그게 시작이에요',
        '지금이 가장 좋은 타이밍이에요!'
      ];
      return messages[Math.floor(Math.random() * messages.length)];
    }

    /**
     * 반복 유형 라벨 반환
     */
    function getRepeatLabel(repeatType, task = null) {
      const labels = {
        'daily': '매일',
        'weekdays': '평일',
        'weekends': '주말',
        'weekly': '매주',
        'monthly': '매월'
      };

      if (repeatType === 'custom' && task && task.repeatDays && task.repeatDays.length > 0) {
        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        const selectedDays = task.repeatDays.map(d => dayNames[d]).join(',');
        return `매주 ${selectedDays}`;
      }

      if (repeatType === 'monthly' && task && task.repeatMonthDay) {
        return `매월 ${task.repeatMonthDay}일`;
      }

      return labels[repeatType] || '';
    }

    /**
     * 다음 반복 작업 생성
     */
    function createNextRepeatTask(task) {
      const now = new Date();
      let nextDeadline = null;

      if (task.deadline) {
        const currentDeadline = new Date(task.deadline);
        nextDeadline = new Date(currentDeadline);

        switch (task.repeatType) {
          case 'daily':
            nextDeadline.setDate(nextDeadline.getDate() + 1);
            break;
          case 'weekly':
            nextDeadline.setDate(nextDeadline.getDate() + 7);
            break;
          case 'monthly':
            nextDeadline.setMonth(nextDeadline.getMonth() + 1);
            break;
        }
      }

      return {
        id: Date.now(),
        title: task.title,
        category: task.category,
        deadline: nextDeadline ? nextDeadline.toISOString().slice(0, 16) : '',
        estimatedTime: task.estimatedTime,
        link: task.link,
        expectedRevenue: task.expectedRevenue,
        repeatType: task.repeatType,
        completed: false,
        createdAt: now.toISOString()
      };
    }

    /**
     * 작업 완료 취소
     */
    function uncompleteTask(id) {
      appState.tasks = appState.tasks.map(t => 
        t.id === id ? { ...t, completed: false } : t
      );
      saveState();
      renderStatic();
      showToast('완료 취소', 'success');
    }

    /**
     * 작업 수정 모드 진입
     */
    function editTask(id) {
      const task = appState.tasks.find(t => t.id === id);
      if (!task) return;
      
      appState.detailedTask = { ...task };
      appState.showDetailedAdd = true;
      appState.editingTaskId = id;
      appState.currentTab = 'action'; // 실행 탭으로 이동
      renderStatic();
      
      // 폼으로 스크롤
      setTimeout(() => {
        const formEl = document.querySelector('.add-task-section');
        if (formEl) {
          formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    }

    /**
     * 수정 취소
     */
    function cancelEdit() {
      appState.detailedTask = {
        title: '',
        category: '부업',
        deadline: '',
        estimatedTime: 10,
        link: '',
        expectedRevenue: '',
        repeatType: 'none',
        repeatDays: [],
        repeatMonthDay: null,
        organizer: '',
        eventType: '',
        tags: [],
        subtasks: []
      };
      appState.showDetailedAdd = false;
      appState.editingTaskId = null;
      renderStatic();
    }

    /**
     * 작업 삭제
     */
    function deleteTask(id) {
      if (!confirm('정말 삭제하시겠습니까?')) return;

      appState.tasks = appState.tasks.filter(t => t.id !== id);
      saveState();
      renderStatic();
      showToast('삭제되었습니다', 'success');
    }

    /**
     * 작업 복사
     */
    function copyTask(id) {
      const task = appState.tasks.find(t => t.id === id);
      if (!task) return;

      const newTask = {
        ...task,
        id: Date.now(),
        title: task.title + ' (복사)',
        completed: false,
        createdAt: new Date().toISOString()
      };

      appState.tasks.push(newTask);
      saveState();
      renderStatic();
      showToast('작업이 복사되었습니다', 'success');
    }

    /**
     * 드래그 앤 드롭 - 드래그 시작
     */
    function handleDragStart(e, taskId) {
      appState.draggedTaskId = taskId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', taskId);
    }

    /**
     * 드래그 앤 드롭 - 드래그 종료
     */
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      appState.draggedTaskId = null;

      // 모든 드롭 타겟 표시 제거
      document.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
    }

    /**
     * 드래그 앤 드롭 - 드래그 오버
     */
    function handleDragOver(e, taskId) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      const targetEl = e.currentTarget;
      if (!targetEl.classList.contains('drag-over') && appState.draggedTaskId !== taskId) {
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        targetEl.classList.add('drag-over');
      }
    }

    /**
     * 드래그 앤 드롭 - 드롭
     */
    function handleDrop(e, targetTaskId) {
      e.preventDefault();

      const draggedId = appState.draggedTaskId;
      if (!draggedId || draggedId === targetTaskId) return;

      const tasks = appState.tasks;
      const draggedIndex = tasks.findIndex(t => t.id === draggedId);
      const targetIndex = tasks.findIndex(t => t.id === targetTaskId);

      if (draggedIndex === -1 || targetIndex === -1) return;

      // 작업 순서 변경
      const [draggedTask] = tasks.splice(draggedIndex, 1);
      tasks.splice(targetIndex, 0, draggedTask);

      appState.tasks = tasks;
      saveState();
      renderStatic();
      showToast('순서가 변경되었습니다', 'success');
    }

    /**
     * 링크 열기
     */
    function handleGo(link) {
      if (link) {
        window.open(link, '_blank');
      }
    }

    /**
     * 작업 리스트 토글
     */
    function toggleTaskList() {
      appState.showTaskList = !appState.showTaskList;
      renderStatic();
    }

    /**
     * 완료된 작업 보기 토글
     */
    function toggleCompletedTasks() {
      appState.showCompletedTasks = !appState.showCompletedTasks;
      renderStatic();
    }

    /**
     * 상세 추가 폼 토글
     */
    function toggleDetailedAdd() {
      appState.showDetailedAdd = !appState.showDetailedAdd;
      
      // 수정 중이었으면 취소
      if (!appState.showDetailedAdd && appState.editingTaskId) {
        cancelEdit();
        return;
      }
      
      renderStatic();
    }

    /**
     * 전체 탭에서 카테고리별 완료 작업 토글
     */
    function toggleCompletedCategory(category) {
      if (!appState.showCompletedByCategory) {
        appState.showCompletedByCategory = {};
      }
      appState.showCompletedByCategory[category] = !appState.showCompletedByCategory[category];
      renderStatic();
    }

    /**
     * 카테고리 변경 시 호출
     */
    function updateDetailedTaskCategory(category) {
      appState.detailedTask.category = category;
      renderStatic();
    }

    /**
     * 태그를 작업에 추가
     */
    function addTagToTask(tag) {
      if (!appState.detailedTask.tags) {
        appState.detailedTask.tags = [];
      }
      if (!appState.detailedTask.tags.includes(tag)) {
        appState.detailedTask.tags.push(tag);
        renderStatic();
      }
    }

    /**
     * 작업에서 태그 제거
     */
    function removeTagFromTask(tag) {
      if (appState.detailedTask.tags) {
        appState.detailedTask.tags = appState.detailedTask.tags.filter(t => t !== tag);
        renderStatic();
      }
    }

    /**
     * 새 태그 추가 (전역 목록에도 추가)
     */
    function addNewTag(tagName) {
      const tag = tagName.trim();
      if (!tag) return;

      // 전역 태그 목록에 추가
      if (!appState.availableTags.includes(tag)) {
        appState.availableTags.push(tag);
        saveState();
      }

      // 현재 작업에도 추가
      addTagToTask(tag);
    }

    /**
     * 서브태스크 추가
     */
    function addSubtask(text) {
      const subtaskText = text.trim();
      if (!subtaskText) return;

      if (!appState.detailedTask.subtasks) {
        appState.detailedTask.subtasks = [];
      }

      appState.detailedTask.subtasks.push({
        text: subtaskText,
        completed: false
      });
      renderStatic();
    }

    /**
     * 서브태스크 제거
     */
    function removeSubtask(index) {
      if (appState.detailedTask.subtasks) {
        appState.detailedTask.subtasks.splice(index, 1);
        renderStatic();
      }
    }

    /**
     * 서브태스크 완료 토글 (작업 내에서)
     */
    function toggleSubtaskComplete(taskId, subtaskIndex) {
      const task = appState.tasks.find(t => t.id === taskId);
      if (task && task.subtasks && task.subtasks[subtaskIndex]) {
        task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
        saveState();
        renderStatic();
      }
    }

    /**
     * 반복 유형 변경 시 호출
     */
    function updateDetailedTaskRepeat(repeatType) {
      appState.detailedTask.repeatType = repeatType;
      // 타입 변경 시 관련 필드 초기화
      if (repeatType !== 'custom') {
        appState.detailedTask.repeatDays = [];
      }
      if (repeatType !== 'monthly') {
        appState.detailedTask.repeatMonthDay = null;
      }
      renderStatic();
    }

    /**
     * 특정 요일 토글
     */
    function toggleRepeatDay(dayIndex) {
      if (!appState.detailedTask.repeatDays) {
        appState.detailedTask.repeatDays = [];
      }
      const days = appState.detailedTask.repeatDays;
      const idx = days.indexOf(dayIndex);
      if (idx === -1) {
        days.push(dayIndex);
      } else {
        days.splice(idx, 1);
      }
      days.sort((a, b) => a - b);
      renderStatic();
    }

    /**
     * 매월 반복일 설정
     */
    function updateRepeatMonthDay(day) {
      const dayNum = parseInt(day);
      appState.detailedTask.repeatMonthDay = (dayNum >= 1 && dayNum <= 31) ? dayNum : null;
    }

    /**
     * 일정 필터 변경
     */
    function setScheduleFilter(filter) {
      appState.scheduleFilter = filter;
      renderStatic();
    }

    /**
     * 검색어 변경
     */
    function setSearchQuery(query) {
      appState.searchQuery = query;
      renderStatic();
    }

    /**
     * 검색어 클리어
     */
    function clearSearch() {
      appState.searchQuery = '';
      renderStatic();
    }

    /**
     * 카테고리 필터 변경
     */
    function setCategoryFilter(category) {
      appState.categoryFilter = category;
      renderStatic();
    }

    /**
     * 태그 필터 설정
     */
    function setTagFilter(tag) {
      appState.tagFilter = appState.tagFilter === tag ? null : tag;
      renderStatic();
    }

    /**
     * 검색 및 필터 적용된 작업 목록
     */
    function getSearchFilteredTasks(tasks) {
      let filtered = tasks;

      // 카테고리 필터
      if (appState.categoryFilter !== 'all') {
        filtered = filtered.filter(t => t.category === appState.categoryFilter);
      }

      // 태그 필터
      if (appState.tagFilter) {
        filtered = filtered.filter(t => t.tags && t.tags.includes(appState.tagFilter));
      }

      // 검색어 필터 (제목, 태그, 서브태스크 포함)
      if (appState.searchQuery.trim()) {
        const query = appState.searchQuery.toLowerCase().trim();
        filtered = filtered.filter(t => {
          // 제목 검색
          if (t.title.toLowerCase().includes(query)) return true;
          // 태그 검색
          if (t.tags && t.tags.some(tag => tag.toLowerCase().includes(query))) return true;
          // 서브태스크 검색
          if (t.subtasks && t.subtasks.some(st => st.text.toLowerCase().includes(query))) return true;
          return false;
        });
      }

      return filtered;
    }

    /**
     * 날짜가 주말인지 확인
     */
    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    /**
     * 일정 뷰용 작업 그룹화 (날짜별)
     */
    function getTasksByDate() {
      const now = new Date();
      const tasks = appState.tasks.filter(t => !t.completed && t.deadline);
      const grouped = {};

      // 오늘부터 7일간의 날짜 생성
      for (let i = 0; i < 7; i++) {
        const date = new Date(now);
        date.setDate(date.getDate() + i);
        const dateKey = date.toISOString().split('T')[0];
        grouped[dateKey] = {
          date: date,
          dayName: getDayName(date),
          isToday: i === 0,
          isWeekend: isWeekend(date),
          tasks: []
        };
      }

      // 작업을 날짜별로 분류
      tasks.forEach(task => {
        const taskDate = new Date(task.deadline).toISOString().split('T')[0];
        if (grouped[taskDate]) {
          grouped[taskDate].tasks.push(task);
        }
      });

      // 각 날짜의 작업을 시간순 정렬
      Object.values(grouped).forEach(day => {
        day.tasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
      });

      // 필터 적용
      let result = Object.values(grouped);

      if (appState.scheduleFilter === 'weekday') {
        result = result.filter(day => !day.isWeekend);
      } else if (appState.scheduleFilter === 'weekend') {
        result = result.filter(day => day.isWeekend);
      } else if (appState.scheduleFilter === 'today') {
        result = result.filter(day => day.isToday);
      }

      return result;
    }

    /**
     * 요일 이름 반환
     */
    function getDayName(date) {
      const days = ['일', '월', '화', '수', '목', '금', '토'];
      const day = days[date.getDay()];
      const month = date.getMonth() + 1;
      const dateNum = date.getDate();
      return `${month}/${dateNum} (${day})`;
    }

    /**
     * 시간만 포맷팅
     */
    function formatTime(deadline) {
      const d = new Date(deadline);
      return d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    // ============================================
    // 스와이프 제스처
    // ============================================
    
    function handleTouchStart(e, taskId) {
      appState.touchStart = {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY,
        taskId: taskId
      };
      appState.touchingTaskId = taskId;
    }

    function handleTouchMove(e, taskId) {
      if (!appState.touchStart || appState.touchStart.taskId !== taskId) return;

      const deltaX = e.touches[0].clientX - appState.touchStart.x;
      const deltaY = e.touches[0].clientY - appState.touchStart.y;
      const taskEl = document.getElementById(`task-${taskId}`);

      // 수평 스와이프가 수직보다 클 때만 스와이프로 인식
      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 20) {
        e.preventDefault(); // 스크롤 방지

        if (deltaX < -30) {
          taskEl.classList.add('swiping-left');
          taskEl.classList.remove('swiping-right');
        } else if (deltaX > 30) {
          taskEl.classList.add('swiping-right');
          taskEl.classList.remove('swiping-left');
        }
      }
    }

    function handleTouchEnd(e, taskId) {
      if (!appState.touchStart || appState.touchStart.taskId !== taskId) return;

      const deltaX = e.changedTouches[0].clientX - appState.touchStart.x;
      const taskEl = document.getElementById(`task-${taskId}`);

      if (deltaX < -100) {
        completeTask(taskId);
        if (navigator.vibrate) navigator.vibrate(50);
      } else if (deltaX > 100) {
        deleteTask(taskId);
        if (navigator.vibrate) navigator.vibrate([30, 30, 30]);
      }

      if (taskEl) {
        taskEl.classList.remove('swiping-left', 'swiping-right');
      }
      appState.touchStart = null;
      appState.touchingTaskId = null;
    }

    // ============================================
    // 백업/복원
    // ============================================
    
    /**
     * JSON으로 데이터 내보내기
     */
    function exportData() {
      try {
        const data = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          tasks: appState.tasks,
          shuttleSuccess: appState.shuttleSuccess,
          availableTags: appState.availableTags,
          streak: appState.streak,
          theme: appState.theme
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `navigator-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();

        URL.revokeObjectURL(url);

        // 백업 시간 기록
        localStorage.setItem('navigator-last-backup', new Date().toISOString());

        showToast('📦 백업 완료!', 'success');
      } catch (error) {
        console.error('내보내기 실패:', error);
        showToast('백업 생성 중 오류가 발생했습니다', 'error');
      }
    }

    /**
     * JSON에서 데이터 가져오기
     */
    function importData() {
      const input = document.getElementById('file-import');
      input.click();
    }

    /**
     * 파일 선택 시 처리
     */
    function handleFileImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const data = JSON.parse(event.target.result);
          
          // 데이터 유효성 검사
          if (!data.tasks || !Array.isArray(data.tasks)) {
            throw new Error('잘못된 파일 형식입니다');
          }
          
          // 데이터 복원
          if (confirm('현재 데이터를 덮어쓰시겠습니까?')) {
            appState.tasks = data.tasks;
            appState.shuttleSuccess = data.shuttleSuccess || false;
            saveState();
            renderStatic();
            showToast('데이터를 복원했습니다', 'success');
          }
        } catch (error) {
          console.error('가져오기 실패:', error);
          showToast('파일을 읽을 수 없습니다', 'error');
        }
      };
      reader.readAsText(file);
      
      // 인풋 초기화 (같은 파일 다시 선택 가능하게)
      e.target.value = '';
    }

    // ============================================
    // UI 헬퍼
    // ============================================
    
    /**
     * 토스트 알림 표시
     */
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    // ============================================
    // 온보딩 & 스트릭 & 포커스 모드
    // ============================================

    /**
     * 온보딩 모달 표시
     */
    function showOnboarding() {
      appState.showOnboarding = true;
      renderStatic();
    }

    /**
     * 온보딩 완료 및 샘플 데이터 추가
     */
    function completeOnboarding(addSamples = true) {
      localStorage.setItem('navigator-visited', 'true');
      appState.showOnboarding = false;

      if (addSamples) {
        const now = new Date();
        const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

        const sampleTasks = [
          {
            id: Date.now(),
            title: '👋 Navigator 사용법 익히기',
            category: '일상',
            estimatedTime: 5,
            tags: ['긴급'],
            subtasks: [
              { text: '작업 추가해보기', completed: false },
              { text: '완료 체크해보기', completed: false },
              { text: '태그 사용해보기', completed: false }
            ],
            completed: false,
            createdAt: now.toISOString()
          },
          {
            id: Date.now() + 1,
            title: '오늘 할 일 정리하기',
            category: '일상',
            estimatedTime: 10,
            deadline: tomorrow.toISOString().slice(0, 16),
            tags: [],
            subtasks: [],
            completed: false,
            createdAt: now.toISOString()
          },
          {
            id: Date.now() + 2,
            title: '주간 목표 세우기',
            category: '본업',
            estimatedTime: 15,
            deadline: nextWeek.toISOString().slice(0, 16),
            tags: ['회의'],
            subtasks: [],
            completed: false,
            createdAt: now.toISOString()
          }
        ];

        appState.tasks = sampleTasks;
        saveState();
        showToast('🎉 샘플 작업이 추가되었습니다!', 'success');
      }

      renderStatic();
    }

    /**
     * 스트릭 업데이트
     */
    function updateStreak() {
      const today = new Date().toDateString();
      const lastActive = appState.streak.lastActiveDate;

      if (!lastActive) {
        // 첫 사용
        return;
      }

      const lastDate = new Date(lastActive);
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);

      if (lastDate.toDateString() === yesterday.toDateString()) {
        // 어제 활동함 → 스트릭 유지
      } else if (lastDate.toDateString() !== today) {
        // 어제 활동 안 함 → 스트릭 리셋
        appState.streak.current = 0;
      }
    }

    /**
     * 오늘 활동 기록 (작업 완료 시 호출)
     */
    function recordActivity() {
      const today = new Date().toDateString();

      if (appState.streak.lastActiveDate !== today) {
        appState.streak.current++;
        appState.streak.lastActiveDate = today;

        if (appState.streak.current > appState.streak.best) {
          appState.streak.best = appState.streak.current;
        }

        localStorage.setItem('navigator-streak', JSON.stringify(appState.streak));

        if (appState.streak.current > 1) {
          showToast(`🔥 ${appState.streak.current}일 연속 달성!`, 'success');
        }
      }
    }

    /**
     * 백업 리마인더 체크
     */
    function checkBackupReminder() {
      const lastBackup = localStorage.getItem('navigator-last-backup');
      const now = new Date();

      if (!lastBackup) {
        // 첫 사용이거나 백업 기록 없음
        return;
      }

      const daysSinceBackup = (now - new Date(lastBackup)) / (1000 * 60 * 60 * 24);

      if (daysSinceBackup >= 7) {
        setTimeout(() => {
          if (confirm('📦 마지막 백업 후 7일이 지났습니다.\n\n지금 백업하시겠습니까?')) {
            exportData();
          }
        }, 2000);
      }
    }

    /**
     * 포커스 모드 토글
     */
    function toggleFocusMode() {
      appState.focusMode = !appState.focusMode;
      renderStatic();

      if (appState.focusMode) {
        showToast('🎯 포커스 모드: 가장 중요한 작업 1개만 표시', 'success');
      }
    }

    /**
     * 마감시간 포맷팅
     */
    function formatDeadline(deadline) {
      const now = new Date();
      const d = new Date(deadline);
      const hoursLeft = (d - now) / (1000 * 60 * 60);
      
      if (hoursLeft < 1) {
        return `${Math.round(hoursLeft * 60)}분 후`;
      } else if (hoursLeft < 24) {
        return `${Math.round(hoursLeft)}시간 후`;
      }
      
      return d.toLocaleString('ko-KR', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ============================================
    // 렌더링
    // ============================================
    
    /**
     * 전체 화면 렌더링 (상태 변경 시 호출)
     */
    function renderStatic() {
      const now = new Date();
      const hour = now.getHours();
      const filteredTasks = getFilteredTasks();
      const nextAction = filteredTasks[0] || null;
      const mode = getCurrentMode();
      const categoryStats = getCategoryStats();
      const urgentTasks = getUrgentTasks();
      
      const stats = {
        total: appState.tasks.length,
        completed: appState.tasks.filter(t => t.completed).length,
        remaining: appState.tasks.filter(t => !t.completed).length
      };
      
      const completedTasks = appState.tasks.filter(t => t.completed);
      const hiddenCount = appState.tasks.filter(t => !t.completed).length - filteredTasks.length;
      
      const bedtime = new Date(now);
      bedtime.setHours(24, 0, 0, 0);
      const minutesUntilBed = Math.floor((bedtime - now) / (1000 * 60));
      
      const urgencyClass = nextAction ? nextAction.urgency : 'normal';
      const urgencyLabel = {
        'urgent': '🚨 긴급!',
        'warning': '⚠️ 주의',
        'normal': '▶ 지금 할 것',
        'expired': '❌ 마감 지남'
      };

      // 반복 옵션 공통 필드
      const repeatField = `
        <div class="form-group">
          <label class="form-label">반복 설정</label>
          <select class="form-select" id="detailed-repeat" onchange="updateDetailedTaskRepeat(this.value)">
            <option value="none" ${appState.detailedTask.repeatType === 'none' ? 'selected' : ''}>반복 안 함</option>
            <option value="daily" ${appState.detailedTask.repeatType === 'daily' ? 'selected' : ''}>매일</option>
            <option value="weekdays" ${appState.detailedTask.repeatType === 'weekdays' ? 'selected' : ''}>평일만 (월~금)</option>
            <option value="weekends" ${appState.detailedTask.repeatType === 'weekends' ? 'selected' : ''}>주말만 (토~일)</option>
            <option value="weekly" ${appState.detailedTask.repeatType === 'weekly' ? 'selected' : ''}>매주</option>
            <option value="custom" ${appState.detailedTask.repeatType === 'custom' ? 'selected' : ''}>특정 요일</option>
            <option value="monthly" ${appState.detailedTask.repeatType === 'monthly' ? 'selected' : ''}>매월</option>
          </select>
          ${appState.detailedTask.repeatType === 'custom' ? `
            <div class="repeat-days">
              ${['일', '월', '화', '수', '목', '금', '토'].map((day, index) => `
                <label class="repeat-day-option">
                  <input type="checkbox"
                    ${(appState.detailedTask.repeatDays || []).includes(index) ? 'checked' : ''}
                    onchange="toggleRepeatDay(${index})">
                  <span>${day}</span>
                </label>
              `).join('')}
            </div>
          ` : ''}
          ${appState.detailedTask.repeatType === 'monthly' ? `
            <div class="repeat-monthly">
              <label class="form-label" style="margin-top: 10px;">매월 반복일</label>
              <input type="number" class="form-input" id="detailed-repeat-day"
                min="1" max="31"
                placeholder="1~31"
                value="${appState.detailedTask.repeatMonthDay || ''}"
                onchange="updateRepeatMonthDay(this.value)">
            </div>
          ` : ''}
          <div class="form-note">* 완료 시 다음 주기 작업이 자동 생성됩니다</div>
        </div>
      `;

      // 카테고리별 입력 필드
      const categoryFields = {
        '본업': `
          <div class="form-group">
            <label class="form-label">마감시간</label>
            <input type="datetime-local" class="form-input" id="detailed-deadline" value="${appState.detailedTask.deadline}">
          </div>
          <div class="form-group">
            <label class="form-label">예상 소요시간 (분)</label>
            <input type="number" class="form-input" id="detailed-time" value="${appState.detailedTask.estimatedTime}">
          </div>
          ${repeatField}
          <div class="form-group">
            <label class="form-label">링크</label>
            <input type="url" class="form-input" id="detailed-link" placeholder="https://" value="${appState.detailedTask.link}">
          </div>
        `,
        '부업': `
          <div class="form-group">
            <label class="form-label">주최자</label>
            <select class="form-select" id="detailed-organizer">
              <option value="" ${!appState.detailedTask.organizer ? 'selected' : ''}>선택하세요</option>
              <option value="불개미" ${appState.detailedTask.organizer === '불개미' ? 'selected' : ''}>불개미</option>
              <option value="코같투" ${appState.detailedTask.organizer === '코같투' ? 'selected' : ''}>코같투</option>
              <option value="맨틀" ${appState.detailedTask.organizer === '맨틀' ? 'selected' : ''}>맨틀</option>
              <option value="xmaquina" ${appState.detailedTask.organizer === 'xmaquina' ? 'selected' : ''}>xmaquina</option>
              <option value="기타" ${appState.detailedTask.organizer === '기타' ? 'selected' : ''}>기타</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">이벤트 종류</label>
            <select class="form-select" id="detailed-eventType">
              <option value="" ${!appState.detailedTask.eventType ? 'selected' : ''}>선택하세요</option>
              <option value="의견작성" ${appState.detailedTask.eventType === '의견작성' ? 'selected' : ''}>의견작성</option>
              <option value="리캡작성" ${appState.detailedTask.eventType === '리캡작성' ? 'selected' : ''}>리캡작성</option>
              <option value="AMA참여" ${appState.detailedTask.eventType === 'AMA참여' ? 'selected' : ''}>AMA참여</option>
              <option value="아티클작성" ${appState.detailedTask.eventType === '아티클작성' ? 'selected' : ''}>아티클작성</option>
              <option value="영상제작" ${appState.detailedTask.eventType === '영상제작' ? 'selected' : ''}>영상제작</option>
              <option value="커뮤니티" ${appState.detailedTask.eventType === '커뮤니티' ? 'selected' : ''}>커뮤니티</option>
              <option value="기타" ${appState.detailedTask.eventType === '기타' ? 'selected' : ''}>기타</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">마감시간</label>
            <input type="datetime-local" class="form-input" id="detailed-deadline" value="${appState.detailedTask.deadline}">
          </div>
          <div class="form-group">
            <label class="form-label">링크</label>
            <input type="url" class="form-input" id="detailed-link" placeholder="https://t.me/..." value="${appState.detailedTask.link}">
          </div>
        `,
        '일상': `
          <div class="form-group">
            <label class="form-label">예상 소요시간 (분)</label>
            <input type="number" class="form-input" id="detailed-time" value="${appState.detailedTask.estimatedTime}">
          </div>
          ${repeatField}
        `,
        '가족': `
          <div class="form-group">
            <label class="form-label">마감시간 (선택)</label>
            <input type="datetime-local" class="form-input" id="detailed-deadline" value="${appState.detailedTask.deadline}">
          </div>
          <div class="form-group">
            <label class="form-label">예상 소요시간 (분)</label>
            <input type="number" class="form-input" id="detailed-time" value="${appState.detailedTask.estimatedTime}">
          </div>
          ${repeatField}
          <div class="form-group">
            <label class="form-label">메모/링크 (선택)</label>
            <input type="text" class="form-input" id="detailed-link" placeholder="메모 또는 URL" value="${appState.detailedTask.link}">
          </div>
        `
      };

      document.getElementById('root').innerHTML = `
        <div class="app">
          <div class="header">
            <div class="header-left">
              <h1>⚡ Navigator</h1>
              <p>생존형 할일 관리 ${appState.streak.current > 0 ? `<span class="header-streak">🔥${appState.streak.current}</span>` : ''}</p>
            </div>
            <div class="header-actions">
              <button class="header-btn shuttle-mini ${appState.shuttleSuccess ? 'success' : 'failed'}" onclick="toggleShuttle()" title="${appState.shuttleSuccess ? '셔틀 탑승 성공' : '셔틀 놓침 (클릭하여 변경)'}">
                ${appState.shuttleSuccess ? '🚌' : '😴'}
              </button>
              <button class="header-btn" onclick="toggleTheme()" title="테마 전환">
                ${appState.theme === 'dark' ? '☀️' : '🌙'}
              </button>
              ${appState.user ? `
                <button class="header-btn" onclick="openSettings()" title="동기화: ${appState.syncStatus}" style="position: relative;">
                  ${appState.syncStatus === 'syncing' ? '🔄' : appState.syncStatus === 'synced' ? '☁️' : appState.syncStatus === 'error' ? '⚠️' : '☁️'}
                  <span style="position: absolute; bottom: 2px; right: 2px; width: 8px; height: 8px; background: ${appState.syncStatus === 'synced' ? '#48bb78' : appState.syncStatus === 'error' ? '#f5576c' : '#667eea'}; border-radius: 50%; border: 1px solid var(--bg-primary);"></span>
                </button>
              ` : `
                <button class="header-btn" onclick="openSettings()" title="로그인하여 동기화">
                  ☁️
                </button>
              `}
              <button class="header-btn" onclick="openSettings()" title="설정">
                ⚙️
              </button>
            </div>
          </div>

          <!-- 탭 네비게이션 -->
          <div class="tab-nav">
            <button class="tab-btn ${appState.currentTab === 'action' ? 'active' : ''}" onclick="switchTab('action')">
              🎯 오늘
            </button>
            <button class="tab-btn ${appState.currentTab === 'events' ? 'active' : ''}" onclick="switchTab('events')">
              💰 이벤트
            </button>
            <button class="tab-btn ${appState.currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">
              📊 통계
            </button>
            <button class="tab-btn ${appState.currentTab === 'all' ? 'active' : ''}" onclick="switchTab('all')">
              📋 전체
            </button>
            <button class="tab-btn ${appState.currentTab === 'history' ? 'active' : ''}" onclick="switchTab('history')">
              📅 히스토리
            </button>
          </div>

          <!-- 실행 탭 -->
          <div class="tab-content ${appState.currentTab === 'action' ? 'active' : ''}">
            <!-- PC 3단 레이아웃 / 모바일 1단 -->
            <div class="pc-layout">
              <!-- 왼쪽 컬럼: 상태 + Next Action -->
              <div class="pc-column-left">
                <!-- 현재 시간 & 남은 시간 -->
                <div class="current-time-section">
                  <div class="current-time-left">
                    <div class="current-time-clock" id="current-clock">${now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</div>
                    <div class="current-time-mode">
                      <span class="current-time-mode-label">현재 모드</span>
                      <span class="current-time-mode-value ${mode}">${mode}</span>
                    </div>
                  </div>
                  <div class="current-time-right">
                    <div class="time-remaining-label">${getModeTimeLabel(mode, hour)}</div>
                    <div class="time-remaining-value ${minutesUntilBed < 60 && hour >= 22 ? 'urgent' : ''}" id="mode-time-remaining">
                      ${getModeTimeRemaining(mode, hour, now)}
                    </div>
                  </div>
                </div>

                <!-- 셔틀 상태는 헤더로 이동됨 -->

                <!-- 일일 목표 진행률 (한 줄) -->
                ${(() => {
                  const dailyGoal = appState.settings.dailyGoal || 5;
                  const completed = appState.todayStats.completedToday;
                  const percentage = Math.min((completed / dailyGoal) * 100, 100);
                  const isComplete = completed >= dailyGoal;

                  return `
                    <div class="daily-goal-compact">
                      <div class="daily-goal-info">
                        <span class="daily-goal-emoji">${isComplete ? '🎉' : '🎯'}</span>
                        <span class="daily-goal-text">오늘 <strong>${completed}</strong>/${dailyGoal}개</span>
                      </div>
                      <div class="daily-goal-bar">
                        <div class="daily-goal-bar-fill ${isComplete ? 'complete' : ''}" style="width: ${percentage}%"></div>
                      </div>
                    </div>
                  `;
                })()}

                ${nextAction ? `
                  <div class="next-action ${urgencyClass}">
                    <div class="next-action-label">${urgencyLabel[urgencyClass]}</div>
                    <div class="task-title">${nextAction.title}</div>
                    <div class="task-meta">
                      <span class="category ${nextAction.category}">${nextAction.category}</span>
                      ${nextAction.repeatType && nextAction.repeatType !== 'none' ? `<span class="meta-item">🔄 ${getRepeatLabel(nextAction.repeatType)}</span>` : ''}
                      ${nextAction.estimatedTime ? `<span class="meta-item">⏱ ${nextAction.estimatedTime}분</span>` : ''}
                      ${nextAction.deadline ? `<span class="meta-item">⏰ ${formatDeadline(nextAction.deadline)}</span>` : ''}
                      ${nextAction.expectedRevenue ? `<span class="meta-item">💰 ${parseInt(nextAction.expectedRevenue).toLocaleString()}원</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 15px;">
                      <button class="btn btn-primary" onclick="handleGo('${nextAction.link || ''}')">
                        ${nextAction.link ? '🚀 GO' : '시작하기'}
                      </button>
                      <button class="quick-timer-btn ${appState.quickTimer.isRunning ? 'running' : ''}" onclick="startQuickTimer(${nextAction.id})">
                        ⏱ <span id="quick-timer-display" class="quick-timer-display">${appState.quickTimer.isRunning ?
                          Math.floor(appState.quickTimer.timeLeft / 60) + ':' + String(appState.quickTimer.timeLeft % 60).padStart(2, '0') :
                          '5분 집중'}</span>
                      </button>
                      <button class="btn btn-success" onclick="completeTask(${nextAction.id})">
                        ✓ 완료
                      </button>
                    </div>
                  </div>
                ` : `
                  <div class="next-action" style="text-align: center;">
                    <div style="font-size: 60px; margin-bottom: 15px;">🎉</div>
                    <div class="next-action-label" style="color: #48bb78;">✨ 모든 작업 완료!</div>
                    <div class="task-title" style="color: #48bb78; font-size: 24px;">대단해요!</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-top: 15px; line-height: 1.6">
                      ${(() => {
                        const messages = [
                          '오늘 하루도 수고 많으셨어요! 🌟',
                          '자신에게 작은 보상을 주세요 ☕',
                          '충분히 쉬어도 괜찮아요 😴',
                          '내일도 화이팅! 💪',
                          '잠시 스트레칭 어때요? 🧘'
                        ];
                        return messages[Math.floor(Math.random() * messages.length)];
                      })()}
                    </div>
                  </div>
                `}

                ${hiddenCount > 0 ? `
                  <div class="hidden-tasks">
                    오늘 못 할 것 ${hiddenCount}개 숨김<br>
                    <span style="font-size: 12px">내일 하면 됩니다</span>
                  </div>
                ` : ''}
              </div>

              <!-- 중간 컬럼: 빠른 추가 + 작업 목록 -->
              <div class="pc-column-center">
                <!-- 빠른 추가 (상단으로 이동) -->
                <div class="quick-add-simple">
                  <input
                    type="text"
                    id="quick-add-input"
                    class="quick-add-input"
                    placeholder="+ 새 작업 추가..."
                    value="${appState.quickAddValue}"
                    onkeypress="if(event.key==='Enter') quickAdd()"
                  >
                  <button class="quick-add-btn" onclick="quickAdd()">+</button>
                </div>

                <!-- 다른 작업 목록 (접기/펼치기) -->
                <div class="other-tasks-section">
                  <div class="other-tasks-header" onclick="toggleTaskList()">
                    <span>📋 다른 작업 ${filteredTasks.filter(t => !t.completed).length - (nextAction ? 1 : 0)}개</span>
                    <span class="other-tasks-toggle">${appState.showTaskList ? '▲' : '▼'}</span>
                  </div>

                  ${appState.showTaskList ? `
                    <!-- 검색 (펼쳐졌을 때만) -->
                    <div class="search-simple">
                      <input
                        type="text"
                        class="search-input"
                        placeholder="🔍 검색..."
                        value="${appState.searchQuery}"
                        oninput="setSearchQuery(this.value)"
                      >
                      ${appState.searchQuery ? `<button class="search-clear" onclick="clearSearch()">×</button>` : ''}
                    </div>

                    <!-- 작업 목록 (펼쳐졌을 때만) -->
                    <div class="task-list-inner">
                      ${filteredTasks
                        .filter(t => !t.completed && t.id !== (nextAction ? nextAction.id : null))
                        .slice(0, 10)
                        .map(task => `
                          <div class="task-item-mini" onclick="editTask(${task.id})">
                            <div class="task-item-mini-left">
                              <button class="task-check-btn" onclick="event.stopPropagation(); completeTask(${task.id})">○</button>
                              <span class="task-item-mini-title">${task.title}</span>
                            </div>
                            <span class="task-item-mini-category ${task.category}">${task.category}</span>
                          </div>
                        `).join('')}
                      ${filteredTasks.filter(t => !t.completed && t.id !== (nextAction ? nextAction.id : null)).length > 10 ? `
                        <div class="task-list-more">+ ${filteredTasks.filter(t => !t.completed).length - 10}개 더...</div>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>

                ${appState.showDetailedAdd ? `
                  <div class="add-task-section">
                    <h3>${appState.editingTaskId ? '✏️ 작업 수정' : '➕ 상세 입력'}</h3>
                    <div class="form-group">
                      <label class="form-label">카테고리</label>
                      <select class="form-select" id="detailed-category" onchange="updateDetailedTaskCategory(this.value)">
                        <option value="본업" ${appState.detailedTask.category === '본업' ? 'selected' : ''}>본업</option>
                        <option value="부업" ${appState.detailedTask.category === '부업' ? 'selected' : ''}>부업</option>
                        <option value="일상" ${appState.detailedTask.category === '일상' ? 'selected' : ''}>일상</option>
                        <option value="가족" ${appState.detailedTask.category === '가족' ? 'selected' : ''}>가족</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">제목</label>
                      <input type="text" class="form-input" id="detailed-title" placeholder="작업 제목" value="${appState.detailedTask.title}">
                    </div>
                    ${categoryFields[appState.detailedTask.category]}

                    <!-- 태그 입력 -->
                    <div class="form-group">
                      <label class="form-label">태그</label>
                      <div class="tags-input-container">
                        <div class="selected-tags">
                          ${(appState.detailedTask.tags || []).map(tag => `
                            <span class="tag selected" onclick="removeTagFromTask('${tag}')">${tag} ×</span>
                          `).join('')}
                        </div>
                        <div class="available-tags">
                          ${appState.availableTags.filter(tag => !(appState.detailedTask.tags || []).includes(tag)).map(tag => `
                            <span class="tag" onclick="addTagToTask('${tag}')">${tag}</span>
                          `).join('')}
                        </div>
                        <div class="new-tag-input">
                          <input type="text" class="form-input tag-input" id="new-tag-input" placeholder="새 태그 입력 후 Enter">
                        </div>
                      </div>
                    </div>

                    <!-- 서브태스크 입력 -->
                    <div class="form-group">
                      <label class="form-label">서브태스크 (단계별 할일)</label>
                      <div class="subtasks-container">
                        ${(appState.detailedTask.subtasks || []).map((subtask, index) => `
                          <div class="subtask-item">
                            <span class="subtask-number">${index + 1}</span>
                            <span class="subtask-text">${subtask.text}</span>
                            <button class="subtask-remove" onclick="removeSubtask(${index})">×</button>
                          </div>
                        `).join('')}
                        <div class="subtask-add">
                          <input type="text" class="form-input subtask-input" id="new-subtask-input" placeholder="서브태스크 추가 후 Enter">
                        </div>
                      </div>
                    </div>

                    ${appState.editingTaskId ? `
                      <button class="btn btn-primary" onclick="detailedAdd()">✓ 수정 완료</button>
                      <button class="btn btn-secondary" onclick="cancelEdit()">✕ 취소</button>
                    ` : `
                      <button class="btn btn-primary" onclick="detailedAdd()">추가하기</button>
                    `}
                  </div>
                ` : ''}

                <!-- 포커스 모드 표시 -->
                ${appState.focusMode && filteredTasks.length > 0 ? `
                  <div class="focus-mode-container">
                    <div class="focus-mode-header">
                      <span>🎯 포커스 모드</span>
                      <span class="focus-mode-hint">가장 중요한 작업에 집중하세요</span>
                    </div>
                    <div class="focus-task">
                      <div class="focus-task-title">${filteredTasks[0].title}</div>
                      <div class="focus-task-meta">
                        <span class="category ${filteredTasks[0].category}">${filteredTasks[0].category}</span>
                        ${filteredTasks[0].estimatedTime ? ` · ${filteredTasks[0].estimatedTime}분` : ''}
                        ${filteredTasks[0].deadline ? ` · ${formatDeadline(filteredTasks[0].deadline)}` : ''}
                      </div>
                      ${filteredTasks[0].subtasks && filteredTasks[0].subtasks.length > 0 ? `
                        <div class="focus-subtasks">
                          ${filteredTasks[0].subtasks.map((st, idx) => `
                            <div class="focus-subtask ${st.completed ? 'completed' : ''}" onclick="toggleSubtaskComplete(${filteredTasks[0].id}, ${idx})">
                              <span class="focus-subtask-check">${st.completed ? '✓' : '○'}</span>
                              <span>${st.text}</span>
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                      <div class="focus-actions">
                        <button class="btn btn-primary btn-large" onclick="completeTask(${filteredTasks[0].id})">
                          ✓ 완료!
                        </button>
                        ${filteredTasks[0].link ? `
                          <button class="btn btn-secondary" onclick="handleGo('${filteredTasks[0].link}')">
                            🔗 열기
                          </button>
                        ` : ''}
                      </div>
                    </div>
                    <div class="focus-remaining">
                      나머지 ${filteredTasks.length - 1}개 작업 대기 중
                    </div>
                  </div>
                ` : ''}

                ${filteredTasks.length > 0 && !appState.focusMode ? `
                  <!-- 스와이프 힌트 -->
                  ${!localStorage.getItem('navigator-hide-swipe-hint') ? `
                    <div class="swipe-hint">
                      <span class="swipe-hint-icon">👆</span>
                      <span class="swipe-hint-text">
                        작업을 <strong>왼쪽으로 밀면 완료</strong>, <strong>오른쪽으로 밀면 삭제</strong>
                      </span>
                      <button class="swipe-hint-close" onclick="dismissSwipeHint()">✕</button>
                    </div>
                  ` : ''}
                  <div class="task-list-section">
                    <div class="task-list-header" onclick="toggleTaskList()">
                      <div class="task-list-title">📋 전체 목록</div>
                      <div class="task-list-count">${filteredTasks.length}개 ${appState.showTaskList ? '▼' : '▶'}</div>
                    </div>
                    <div class="task-list ${appState.showTaskList ? 'show' : ''}">
                      ${filteredTasks.map((task, index) => `
                        <div
                          id="task-${task.id}"
                          class="task-item ${task.urgency === 'urgent' ? 'urgent' : ''} ${task.urgency === 'warning' ? 'warning' : ''}"
                          draggable="true"
                          ondragstart="handleDragStart(event, ${task.id})"
                          ondragend="handleDragEnd(event)"
                          ondragover="handleDragOver(event, ${task.id})"
                          ondrop="handleDrop(event, ${task.id})"
                          ontouchstart="handleTouchStart(event, ${task.id})"
                          ontouchmove="handleTouchMove(event, ${task.id})"
                          ontouchend="handleTouchEnd(event, ${task.id})"
                        >
                          <div class="swipe-actions left">✓ 완료</div>
                          <div class="swipe-actions right">× 삭제</div>

                          <div class="task-item-header">
                            <div class="task-item-title">${index + 1}. ${task.title}</div>
                          </div>
                          <div class="task-item-meta">
                            <span class="category ${task.category}">${task.category}</span>
                            ${task.repeatType && task.repeatType !== 'none' ? ` · 🔄 ${getRepeatLabel(task.repeatType, task)}` : ''}
                            ${task.estimatedTime ? ` · ${task.estimatedTime}분` : ''}
                            ${task.deadline ? ` · ${formatDeadline(task.deadline)}` : ''}
                            ${task.priority ? ` · 점수: ${Math.round(task.priority)}` : ''}
                          </div>
                          ${task.tags && task.tags.length > 0 ? `
                            <div class="task-tags">
                              ${task.tags.map(tag => `<span class="task-tag">#${tag}</span>`).join('')}
                            </div>
                          ` : ''}
                          ${task.subtasks && task.subtasks.length > 0 ? `
                            <div class="task-subtasks">
                              ${task.subtasks.map((subtask, idx) => `
                                <div class="task-subtask ${subtask.completed ? 'completed' : ''}">
                                  <input type="checkbox" class="task-subtask-checkbox"
                                    ${subtask.completed ? 'checked' : ''}
                                    onchange="toggleSubtaskComplete(${task.id}, ${idx})">
                                  <span class="task-subtask-text">${subtask.text}</span>
                                </div>
                              `).join('')}
                              <div class="subtask-progress">
                                ${task.subtasks.filter(s => s.completed).length}/${task.subtasks.length} 완료
                              </div>
                            </div>
                          ` : ''}
                          <div class="task-item-actions">
                            ${task.link ? `<button class="btn-small go" onclick="handleGo('${task.link}')">GO</button>` : ''}
                            <button class="btn-small complete" onclick="completeTask(${task.id})">✓</button>
                            <button class="btn-small edit" onclick="editTask(${task.id})">✏️</button>
                            <button class="btn-small copy" onclick="copyTask(${task.id})">📋</button>
                            <button class="btn-small delete" onclick="deleteTask(${task.id})">×</button>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                ${appState.showCompletedTasks && completedTasks.length > 0 ? `
                  <div class="task-list-section">
                    <div class="task-list-header" onclick="toggleCompletedTasks()">
                      <div class="task-list-title">✓ 완료한 작업</div>
                      <div class="task-list-count">${completedTasks.length}개 ${appState.showCompletedTasks ? '▼' : '▶'}</div>
                    </div>
                    <div class="task-list show">
                      ${completedTasks.map((task, index) => `
                        <div id="task-completed-${task.id}" class="task-item completed">
                          <div class="task-item-header">
                            <div class="task-item-title completed">${index + 1}. ${task.title}</div>
                          </div>
                          <div class="task-item-meta">
                            <span class="category ${task.category}">${task.category}</span>
                            ${task.estimatedTime ? ` · ${task.estimatedTime}분` : ''}
                          </div>
                          <div class="task-item-actions">
                            <button class="btn-small uncomplete" onclick="uncompleteTask(${task.id})">↩️ 되돌리기</button>
                            <button class="btn-small delete" onclick="deleteTask(${task.id})">× 삭제</button>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                ${appState.tasks.length === 0 ? `
                  <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <div>작업이 없습니다</div>
                    <div style="font-size: 14px; margin-top: 10px">새 작업을 추가해보세요</div>
                  </div>
                ` : ''}
              </div>

              <!-- 오른쪽 컬럼: 통계 + 설정 -->
              <div class="pc-column-right">
                <!-- 오늘의 진행률 -->
                <div class="today-progress">
                  <div class="today-progress-header">
                    <span class="today-progress-title">오늘의 진행률</span>
                    <span class="today-progress-score">${stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0}%</span>
                  </div>
                  <div class="progress-bar-large">
                    <div class="progress-bar-fill" style="width: ${stats.total > 0 ? (stats.completed / stats.total) * 100 : 0}%"></div>
                  </div>
                  <div class="today-stats-row">
                    <div class="today-stat">
                      <div class="today-stat-value completed">${stats.completed}</div>
                      <div class="today-stat-label">완료</div>
                    </div>
                    <div class="today-stat">
                      <div class="today-stat-value remaining">${stats.remaining}</div>
                      <div class="today-stat-label">남음</div>
                    </div>
                    <div class="today-stat">
                      <div class="today-stat-value streak">${appState.todayStats.streak > 0 ? '🔥' + appState.todayStats.streak : '-'}</div>
                      <div class="today-stat-label">연속</div>
                    </div>
                  </div>
                </div>

                <!-- 카테고리별 현황 (PC에서만 표시) -->
                <div class="dashboard-section">
                  <div class="dashboard-title">📊 카테고리별</div>
                  <div class="category-stats">
                    ${categoryStats.map(stat => `
                      <div class="category-stat">
                        <div class="category-stat-header">
                          <span class="category ${stat.category}">${stat.category}</span>
                          <span class="category-progress">${stat.completed}/${stat.total + stat.completed}</span>
                        </div>
                        <div class="progress-bar">
                          <div class="progress-fill ${stat.category}" style="width: ${stat.percentage}%"></div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>

                ${urgentTasks.length > 0 ? `
                  <div class="dashboard-section">
                    <div class="dashboard-title">🚨 마감 임박</div>
                    <div class="urgent-list">
                      ${urgentTasks.slice(0, 3).map(task => `
                        <div class="urgent-item">
                          <div class="urgent-item-title">${task.title}</div>
                          <div class="urgent-item-time">⏰ ${formatDeadline(task.deadline)}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                <!-- PWA 설치 배너 -->
                <div id="install-banner" class="install-banner">
                  <div class="install-banner-content">
                    <div class="install-banner-text">
                      📱 홈 화면에 추가하면 더 빠르게!
                    </div>
                    <button class="install-banner-btn" onclick="installPWA()">설치</button>
                    <button class="install-banner-close" onclick="closeInstallBanner()">×</button>
                  </div>
                </div>

                <!-- 알림 설정 -->
                <div class="notification-section">
                  <div class="notification-title">🔔 마감 알림</div>
                  <div class="notification-status">
                    ${appState.notificationPermission === 'granted' ? `
                      <span class="notification-text granted">✓ 활성화됨</span>
                      <button class="notification-btn" disabled>ON</button>
                    ` : appState.notificationPermission === 'denied' ? `
                      <span class="notification-text denied">✕ 차단됨</span>
                      <button class="notification-btn" disabled>OFF</button>
                    ` : `
                      <span class="notification-text">알림 받기</span>
                      <button class="notification-btn" onclick="requestNotificationPermission()">켜기</button>
                    `}
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- 일정 탭 -->
          <div class="tab-content ${appState.currentTab === 'schedule' ? 'active' : ''}">
            <div class="schedule-filter">
              <button class="schedule-filter-btn ${appState.scheduleFilter === 'all' ? 'active' : ''}" onclick="setScheduleFilter('all')">
                전체
              </button>
              <button class="schedule-filter-btn ${appState.scheduleFilter === 'today' ? 'active' : ''}" onclick="setScheduleFilter('today')">
                오늘
              </button>
              <button class="schedule-filter-btn ${appState.scheduleFilter === 'weekday' ? 'active' : ''}" onclick="setScheduleFilter('weekday')">
                평일
              </button>
              <button class="schedule-filter-btn ${appState.scheduleFilter === 'weekend' ? 'active' : ''}" onclick="setScheduleFilter('weekend')">
                주말
              </button>
            </div>

            <div class="schedule-week-grid">
              ${getTasksByDate().map(day => `
                <div class="schedule-day">
                  <div class="schedule-day-header ${day.isToday ? 'today' : ''} ${day.isWeekend ? 'weekend' : ''}">
                    <span>${day.dayName}</span>
                    <span class="schedule-day-count">${day.tasks.length}개</span>
                  </div>
                  <div class="schedule-day-tasks">
                    ${day.tasks.length > 0 ? day.tasks.map(task => `
                      <div class="schedule-task">
                        <span class="schedule-task-time">${formatTime(task.deadline)}</span>
                        <span class="schedule-task-title">${task.title}</span>
                        <span class="schedule-task-category category ${task.category}">${task.category}</span>
                      </div>
                    `).join('') : `
                      <div class="schedule-empty">
                        ${day.isToday ? '오늘은 여유로운 날!' : '일정 없음'}
                      </div>
                    `}
                  </div>
                </div>
              `).join('')}
            </div>

            ${appState.tasks.filter(t => !t.completed && !t.deadline).length > 0 ? `
              <div class="dashboard-section" style="margin-top: 20px;">
                <div class="dashboard-title">📌 마감 없는 작업 (${appState.tasks.filter(t => !t.completed && !t.deadline).length}개)</div>
                <div class="task-list show">
                  ${appState.tasks.filter(t => !t.completed && !t.deadline).map((task, index) => `
                    <div class="task-item">
                      <div class="task-item-header">
                        <div class="task-item-title">${index + 1}. ${task.title}</div>
                      </div>
                      <div class="task-item-meta">
                        <span class="category ${task.category}">${task.category}</span>
                        ${task.estimatedTime ? ` · ${task.estimatedTime}분` : ''}
                      </div>
                      <div class="task-item-actions">
                        <button class="btn-small edit" onclick="editTask(${task.id})">✏️ 마감 추가</button>
                        <button class="btn-small complete" onclick="completeTask(${task.id})">✓</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>

          <!-- 부업 이벤트 탭 -->
          <div class="tab-content ${appState.currentTab === 'events' ? 'active' : ''}">
            ${(() => {
              const eventTasks = appState.tasks.filter(t => t.category === '부업');
              const pendingEvents = eventTasks.filter(t => !t.completed).sort((a, b) => {
                if (!a.deadline) return 1;
                if (!b.deadline) return -1;
                return new Date(a.deadline) - new Date(b.deadline);
              });
              const submittedEvents = eventTasks.filter(t => t.completed).sort((a, b) => {
                return new Date(b.deadline || 0) - new Date(a.deadline || 0);
              });

              const getDaysLeft = (deadline) => {
                if (!deadline) return null;
                const now = new Date();
                const d = new Date(deadline);
                const diff = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
                return diff;
              };

              const formatDday = (days) => {
                if (days === null) return '';
                if (days < 0) return '<span style="color:#f5576c">D+' + Math.abs(days) + '</span>';
                if (days === 0) return '<span style="color:#f5576c">D-Day</span>';
                if (days <= 3) return '<span style="color:#ff9500">D-' + days + '</span>';
                return 'D-' + days;
              };

              const urgentCount = pendingEvents.filter(t => {
                const d = getDaysLeft(t.deadline);
                return d !== null && d <= 3;
              }).length;

              return `
                <div class="events-header">
                  <div class="events-title">💰 이벤트</div>
                  <button class="btn btn-primary" onclick="addNewEvent()">
                    + 새 이벤트
                  </button>
                </div>

                <div class="events-summary">
                  <div class="events-summary-item">
                    <div class="events-summary-value" style="color: ${urgentCount > 0 ? '#f5576c' : '#48bb78'}">${pendingEvents.length}</div>
                    <div class="events-summary-label">미제출</div>
                  </div>
                  <div class="events-summary-item">
                    <div class="events-summary-value" style="color: #ff9500">${urgentCount}</div>
                    <div class="events-summary-label">긴급 (3일내)</div>
                  </div>
                  <div class="events-summary-item">
                    <div class="events-summary-value" style="color: #48bb78">${submittedEvents.length}</div>
                    <div class="events-summary-label">제출완료</div>
                  </div>
                </div>

                ${pendingEvents.length > 0 ? `
                  <div class="events-section">
                    <div class="events-section-title">🔴 미제출 (${pendingEvents.length})</div>
                    <div class="events-list">
                      ${pendingEvents.map(task => {
                        const days = getDaysLeft(task.deadline);
                        const metaParts = [
                          task.organizer || '',
                          task.eventType || '',
                          task.deadline ? new Date(task.deadline).toLocaleDateString('ko-KR', {month:'short', day:'numeric'}) : ''
                        ].filter(Boolean);
                        return `
                          <div class="event-card ${days !== null && days <= 1 ? 'urgent' : (days !== null && days <= 3 ? 'warning' : '')}">
                            <div class="event-card-header">
                              <div class="event-title">${task.title}</div>
                              <div class="event-dday">${days !== null ? (days < 0 ? 'D+' + Math.abs(days) : (days === 0 ? 'D-Day' : 'D-' + days)) : ''}</div>
                            </div>
                            <div class="event-meta">
                              ${metaParts.join(' · ')}
                            </div>
                            <div class="event-actions">
                              ${task.link ? `<a href="${task.link}" target="_blank" class="btn btn-small btn-link">🔗 링크</a>` : ''}
                              <button class="btn btn-small btn-submit" onclick="completeTask(${task.id})">✓ 제출완료</button>
                              <button class="btn btn-small btn-edit" onclick="editTask(${task.id})">✏️</button>
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                ` : `
                  <div class="events-empty">
                    <div class="events-empty-icon">🎉</div>
                    <div class="events-empty-text">미제출 이벤트가 없습니다!</div>
                  </div>
                `}

                ${submittedEvents.length > 0 ? `
                  <div class="events-section submitted">
                    <div class="events-section-title" onclick="document.querySelector('.submitted-list').classList.toggle('collapsed')">
                      ✅ 제출완료 (${submittedEvents.length}) <span class="toggle-icon">▼</span>
                    </div>
                    <div class="events-list submitted-list">
                      ${submittedEvents.map(task => `
                        <div class="event-card completed">
                          <div class="event-card-header">
                            <div class="event-title">${task.title}</div>
                          </div>
                          <div class="event-meta">
                            ${task.organizer ? `<span class="event-tag organizer">${task.organizer}</span>` : ''}
                            ${task.eventType ? `<span class="event-tag type">${task.eventType}</span>` : ''}
                          </div>
                          <div class="event-actions">
                            <button class="btn btn-small btn-undo" onclick="uncompleteTask(${task.id})">↩ 취소</button>
                            <button class="btn btn-small btn-delete" onclick="deleteTask(${task.id})">🗑</button>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              `;
            })()}
          </div>

          <!-- 대시보드 탭 -->
          <div class="tab-content ${appState.currentTab === 'dashboard' ? 'active' : ''}">
            <div class="dashboard-section">
              <div class="dashboard-title">📈 오늘 요약</div>
              <div class="stats">
                <div class="stat-card">
                  <div class="stat-value">${stats.total}</div>
                  <div class="stat-label">전체 작업</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" style="color: #48bb78">${stats.completed}</div>
                  <div class="stat-label">완료</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value">${stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0}%</div>
                  <div class="stat-label">완료율</div>
                </div>
                <div class="stat-card streak">
                  <div class="stat-value">🔥 ${appState.streak.current}</div>
                  <div class="stat-label">연속 달성</div>
                  ${appState.streak.best > 0 ? `<div class="stat-best">최고: ${appState.streak.best}일</div>` : ''}
                </div>
              </div>
            </div>

            <div class="dashboard-section">
              <div class="dashboard-title">📊 카테고리별 현황</div>
              <div class="category-stats">
                ${categoryStats.map(stat => `
                  <div class="category-stat">
                    <div class="category-stat-header">
                      <span class="category ${stat.category}">${stat.category}</span>
                      <span class="category-progress">${stat.completed}/${stat.total + stat.completed} 완료</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill ${stat.category}" style="width: ${stat.percentage}%"></div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            ${urgentTasks.length > 0 ? `
              <div class="dashboard-section">
                <div class="dashboard-title">🚨 마감 임박</div>
                <div class="urgent-list">
                  ${urgentTasks.slice(0, 5).map(task => `
                    <div class="urgent-item">
                      <div class="urgent-item-title">${task.title}</div>
                      <div class="urgent-item-time">⏰ ${formatDeadline(task.deadline)}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${(() => {
              const hourlyProd = getHourlyProductivity();
              const catDist = getCategoryDistribution();
              const dayProd = getDayOfWeekProductivity();

              if (hourlyProd.totalCompleted < 3) return '';

              // 시간대별 바 차트 데이터 (주요 시간대만)
              const timeSlots = [
                { label: '아침', count: hourlyProd.periods.morning.count },
                { label: '점심', count: hourlyProd.periods.lunch.count },
                { label: '오후', count: hourlyProd.periods.afternoon.count },
                { label: '저녁', count: hourlyProd.periods.evening.count },
                { label: '밤', count: hourlyProd.periods.night.count }
              ];
              const maxSlot = Math.max(...timeSlots.map(s => s.count), 1);

              // 파이 차트 그라디언트 계산
              const colors = {
                '본업': '#667eea',
                '부업': '#f093fb',
                '일상': '#4ecdc4',
                '가족': '#ffd93d',
                '기타': '#888'
              };
              let gradientParts = [];
              let currentDeg = 0;
              catDist.distribution.forEach(item => {
                const deg = (item.percentage / 100) * 360;
                const color = colors[item.category] || '#888';
                gradientParts.push(color + ' ' + currentDeg + 'deg ' + (currentDeg + deg) + 'deg');
                currentDeg += deg;
              });
              const pieGradient = gradientParts.length > 0
                ? 'conic-gradient(' + gradientParts.join(', ') + ')'
                : 'var(--bg-secondary)';

              // 시간대 바 HTML 생성
              const timeBarsHtml = timeSlots.map(slot =>
                '<div class="insight-bar ' + (slot.count === maxSlot ? 'peak' : '') + '" ' +
                'style="height: ' + Math.max((slot.count / maxSlot) * 100, 8) + '%" ' +
                'title="' + slot.label + ': ' + slot.count + '개"></div>'
              ).join('');

              const timeLabelsHtml = timeSlots.map(slot =>
                '<div class="insight-bar-label">' + slot.label + '</div>'
              ).join('');

              // 요일 바 HTML 생성
              const maxD = Math.max(...dayProd.data.map(x => x.count), 1);
              const dayBarsHtml = dayProd.data.map(d =>
                '<div class="insight-bar ' + (d.count === maxD && d.count > 0 ? 'peak' : '') + '" ' +
                'style="height: ' + Math.max((d.count / maxD) * 100, 8) + '%" ' +
                'title="' + d.name + ': ' + d.count + '개"></div>'
              ).join('');

              const dayLabelsHtml = dayProd.data.map(d =>
                '<div class="insight-bar-label">' + d.name + '</div>'
              ).join('');

              // 카테고리 레전드 HTML 생성
              const legendHtml = catDist.distribution.map(item =>
                '<div class="pie-legend-item">' +
                '<div class="pie-legend-color ' + item.category + '"></div>' +
                '<span>' + item.category + '</span>' +
                '<span class="pie-legend-value">' + item.count + '개 (' + item.percentage + '%)</span>' +
                '</div>'
              ).join('');

              return '<div class="dashboard-section insights-section">' +
                '<div class="insights-title">🔍 나의 생산성 패턴</div>' +

                '<div class="insight-card">' +
                '<div class="insight-header">' +
                '<span class="insight-label">가장 생산적인 시간대</span>' +
                '<span class="insight-value">' + hourlyProd.bestPeriod.name + '</span>' +
                '</div>' +
                '<div class="insight-bar-container">' + timeBarsHtml + '</div>' +
                '<div class="insight-bar-labels">' + timeLabelsHtml + '</div>' +
                '</div>' +

                '<div class="insight-card">' +
                '<div class="insight-header">' +
                '<span class="insight-label">가장 활발한 요일</span>' +
                '<span class="insight-value">' + dayProd.bestDay + '요일 (' + dayProd.bestDayCount + '개)</span>' +
                '</div>' +
                '<div class="insight-bar-container">' + dayBarsHtml + '</div>' +
                '<div class="insight-bar-labels">' + dayLabelsHtml + '</div>' +
                '</div>' +

                (catDist.total > 0 ?
                  '<div class="insight-card">' +
                  '<div class="insight-header">' +
                  '<span class="insight-label">카테고리 분배</span>' +
                  '<span class="insight-value">총 ' + catDist.total + '개 완료</span>' +
                  '</div>' +
                  '<div class="pie-chart-container">' +
                  '<div class="pie-chart" style="background: ' + pieGradient + '"></div>' +
                  '<div class="pie-legend">' + legendHtml + '</div>' +
                  '</div>' +
                  '</div>'
                : '') +

                '</div>';
            })()}

            <div class="dashboard-section">
              <div class="dashboard-title">📋 전체 작업 목록</div>
              ${appState.tasks.filter(t => !t.completed).length > 0 ? `
                <div class="task-list show">
                  ${appState.tasks.filter(t => !t.completed).map((task, index) => {
                    const urgency = getUrgencyLevel(task);
                    return `
                    <div
                      id="task-dash-${task.id}"
                      class="task-item ${urgency === 'urgent' ? 'urgent' : ''} ${urgency === 'warning' ? 'warning' : ''}"
                    >
                      <div class="task-item-header">
                        <div class="task-item-title">${index + 1}. ${task.title}</div>
                      </div>
                      <div class="task-item-meta">
                        <span class="category ${task.category}">${task.category}</span>
                        ${task.estimatedTime ? ` · ${task.estimatedTime}분` : ''}
                        ${task.deadline ? ` · ${formatDeadline(task.deadline)}` : ''}
                      </div>
                      <div class="task-item-actions">
                        ${task.link ? `<button class="btn-small go" onclick="handleGo('${task.link}')">GO</button>` : ''}
                        <button class="btn-small complete" onclick="completeTask(${task.id})">✓</button>
                        <button class="btn-small edit" onclick="editTask(${task.id})">✏️</button>
                        <button class="btn-small copy" onclick="copyTask(${task.id})">📋</button>
                        <button class="btn-small delete" onclick="deleteTask(${task.id})">×</button>
                      </div>
                    </div>
                  `}).join('')}
                </div>
              ` : `
                <div class="empty-state">
                  <div class="empty-state-icon">✨</div>
                  <div>모든 작업 완료!</div>
                </div>
              `}
            </div>

            ${completedTasks.length > 0 ? `
              <div class="dashboard-section">
                <div class="dashboard-title">✅ 완료한 작업 (${completedTasks.length}개)</div>
                <div class="task-list show">
                  ${completedTasks.slice(0, 10).map((task, index) => `
                    <div class="task-item completed">
                      <div class="task-item-header">
                        <div class="task-item-title completed">${index + 1}. ${task.title}</div>
                      </div>
                      <div class="task-item-meta">
                        <span class="category ${task.category}">${task.category}</span>
                      </div>
                      <div class="task-item-actions">
                        <button class="btn-small uncomplete" onclick="uncompleteTask(${task.id})">↩️</button>
                        <button class="btn-small delete" onclick="deleteTask(${task.id})">×</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
                ${completedTasks.length > 10 ? `
                  <div style="text-align: center; margin-top: 10px; color: var(--text-secondary); font-size: 14px;">
                    최근 10개만 표시 (전체 ${completedTasks.length}개)
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>

          <!-- 전체 목록 탭 -->
          <div class="tab-content ${appState.currentTab === 'all' ? 'active' : ''}">
            <div class="all-tasks-header">
              <h2>📋 전체 작업 목록</h2>
              <div class="all-tasks-summary">
                총 ${appState.tasks.length}개 · 진행 중 ${appState.tasks.filter(t => !t.completed).length}개 · 완료 ${appState.tasks.filter(t => t.completed).length}개
              </div>
            </div>

            ${['본업', '부업', '일상', '가족'].map(category => {
              const categoryTasks = appState.tasks.filter(t => t.category === category);
              const pendingTasks = categoryTasks.filter(t => !t.completed);
              const completedTasks = categoryTasks.filter(t => t.completed);

              if (categoryTasks.length === 0) return '';

              return `
                <div class="all-category-section">
                  <div class="all-category-header ${category}">
                    <span class="all-category-title">${category}</span>
                    <span class="all-category-count">${pendingTasks.length}개 진행 중 / ${completedTasks.length}개 완료</span>
                  </div>

                  ${pendingTasks.length > 0 ? `
                    <div class="all-task-list">
                      ${pendingTasks.map(task => {
                        const urgency = getUrgencyLevel(task);
                        return `
                          <div class="all-task-item ${urgency === 'urgent' ? 'urgent' : ''} ${urgency === 'warning' ? 'warning' : ''}">
                            <div class="all-task-content">
                              <div class="all-task-title">${task.title}</div>
                              <div class="all-task-meta">
                                ${task.estimatedTime ? `⏱️ ${task.estimatedTime}분` : ''}
                                ${task.deadline ? ` · ${formatDeadline(task.deadline)}` : ''}
                                ${task.organizer ? ` · 👤 ${task.organizer}` : ''}
                                ${task.eventType ? ` · 🏷️ ${task.eventType}` : ''}
                              </div>
                            </div>
                            <div class="all-task-actions">
                              ${task.link ? `<button class="btn-small go" onclick="handleGo('${task.link}')">GO</button>` : ''}
                              <button class="btn-small complete" onclick="completeTask(${task.id})">✓</button>
                              <button class="btn-small edit" onclick="editTask(${task.id})">✏️</button>
                              <button class="btn-small copy" onclick="copyTask(${task.id})">📋</button>
                              <button class="btn-small delete" onclick="deleteTask(${task.id})">×</button>
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  ` : ''}

                  ${completedTasks.length > 0 ? `
                    <div class="all-completed-section">
                      <div class="all-completed-toggle" onclick="toggleCompletedCategory('${category}')">
                        ✅ 완료 (${completedTasks.length}개) ${appState.showCompletedByCategory && appState.showCompletedByCategory[category] ? '▲' : '▼'}
                      </div>
                      <div class="all-task-list completed-list ${appState.showCompletedByCategory && appState.showCompletedByCategory[category] ? 'show' : ''}">
                        ${completedTasks.slice(0, 5).map(task => `
                          <div class="all-task-item completed">
                            <div class="all-task-content">
                              <div class="all-task-title completed">${task.title}</div>
                            </div>
                            <div class="all-task-actions">
                              <button class="btn-small uncomplete" onclick="uncompleteTask(${task.id})">↩️</button>
                              <button class="btn-small delete" onclick="deleteTask(${task.id})">×</button>
                            </div>
                          </div>
                        `).join('')}
                        ${completedTasks.length > 5 ? `
                          <div class="all-task-more">+${completedTasks.length - 5}개 더</div>
                        ` : ''}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}

            ${appState.tasks.length === 0 ? `
              <div class="empty-state">
                <div class="empty-state-icon">📝</div>
                <div>등록된 작업이 없습니다</div>
                <div style="margin-top: 10px; font-size: 14px; color: var(--text-secondary);">
                  🎯 오늘 탭에서 새 작업을 추가해보세요
                </div>
              </div>
            ` : ''}
          </div>

          <!-- 히스토리 탭 -->
          <div class="tab-content ${appState.currentTab === 'history' ? 'active' : ''}">
            ${(() => {
              const weeklyStats = getWeeklyStats();
              const totalCompleted = appState.tasks.filter(t => t.completed).length;

              return `
                <div class="history-header">
                  <h2>📅 활동 히스토리</h2>
                  <div class="history-summary">총 ${totalCompleted}개 완료</div>
                </div>

                <!-- 주간 요약 -->
                <div class="week-summary">
                  <div class="week-summary-title">📊 이번 주 요약</div>
                  <div class="week-summary-stats">
                    <div class="week-stat">
                      <div class="week-stat-value">${weeklyStats.total}</div>
                      <div class="week-stat-label">완료</div>
                    </div>
                    <div class="week-stat">
                      <div class="week-stat-value">${weeklyStats.avgPerDay}</div>
                      <div class="week-stat-label">일 평균</div>
                    </div>
                    <div class="week-stat">
                      <div class="week-stat-value">${weeklyStats.activeDays}/7</div>
                      <div class="week-stat-label">활동일</div>
                    </div>
                  </div>

                  <!-- 주간 바 차트 -->
                  ${(() => {
                    const dayLabels = ['일', '월', '화', '수', '목', '금', '토'];
                    const todayIndex = new Date().getDay();
                    const maxCount = Math.max(...weeklyStats.dailyCounts, 1);

                    return `
                      <div class="weekly-chart">
                        ${weeklyStats.dailyCounts.map((count, i) => {
                          const height = (count / maxCount) * 80;
                          const isToday = i === todayIndex;
                          return `
                            <div class="weekly-chart-bar">
                              <div class="weekly-chart-value">${count > 0 ? count : ''}</div>
                              <div class="weekly-chart-fill ${isToday ? 'today' : ''} ${count === 0 ? 'empty' : ''}" style="height: ${height}px"></div>
                              <div class="weekly-chart-label ${isToday ? 'today' : ''}">${dayLabels[i]}</div>
                            </div>
                          `;
                        }).join('')}
                      </div>
                    `;
                  })()}
                </div>

                <!-- 캘린더 -->
                ${renderCalendar()}

                <!-- 선택된 날짜 상세 -->
                ${renderDayDetail()}

                <!-- 최근 기록 -->
                <div class="dashboard-section">
                  <div class="dashboard-title">📜 최근 기록</div>
                  ${renderRecentHistory()}
                </div>
              `;
            })()}
          </div>

          <!-- 온보딩 모달 -->
          ${appState.showOnboarding ? `
            <div class="modal-overlay" onclick="completeOnboarding(false)">
              <div class="modal onboarding-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                  <h2>👋 Navigator에 오신 것을 환영합니다!</h2>
                </div>
                <div class="modal-body">
                  <div class="onboarding-feature">
                    <span class="onboarding-icon">🎯</span>
                    <div>
                      <strong>자동 우선순위</strong>
                      <p>마감일, 카테고리를 기반으로 가장 중요한 작업을 자동 정렬</p>
                    </div>
                  </div>
                  <div class="onboarding-feature">
                    <span class="onboarding-icon">🏷️</span>
                    <div>
                      <strong>태그 & 서브태스크</strong>
                      <p>유연한 분류와 큰 작업의 단계별 분해</p>
                    </div>
                  </div>
                  <div class="onboarding-feature">
                    <span class="onboarding-icon">🔥</span>
                    <div>
                      <strong>연속 달성 스트릭</strong>
                      <p>매일 작업 완료 시 스트릭 증가! 동기부여 UP</p>
                    </div>
                  </div>
                  <div class="onboarding-feature">
                    <span class="onboarding-icon">🎯</span>
                    <div>
                      <strong>포커스 모드</strong>
                      <p>ADHD 친화적! 가장 중요한 작업 1개만 표시</p>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-primary" onclick="completeOnboarding(true)">
                    🚀 샘플 작업으로 시작하기
                  </button>
                  <button class="btn btn-secondary" onclick="completeOnboarding(false)">
                    빈 상태로 시작하기
                  </button>
                </div>
              </div>
            </div>
          ` : ''}

          <!-- 설정 모달 -->
          ${appState.showSettings ? `
            <div class="modal-overlay" onclick="closeSettings()">
              <div class="modal settings-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                  <h2>⚙️ 설정</h2>
                </div>
                <div class="modal-body">
                  <!-- 클라우드 동기화 섹션 -->
                  <div class="settings-section">
                    <div class="settings-section-title">☁️ 클라우드 동기화</div>
                    ${appState.user ? `
                      <div class="user-section">
                        <img class="user-avatar" src="${appState.user.photoURL || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23667eea%22 width=%22100%22 height=%22100%22 rx=%2250%22/><text x=%2250%22 y=%2265%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22>👤</text></svg>'}" alt="프로필">
                        <div class="user-info">
                          <div class="user-name">${appState.user.displayName || '사용자'}</div>
                          <div class="user-email">${appState.user.email}</div>
                          <div id="sync-indicator" class="sync-status ${appState.syncStatus}">
                            <span class="sync-icon">${appState.syncStatus === 'syncing' ? '🔄' : appState.syncStatus === 'synced' ? '✅' : appState.syncStatus === 'error' ? '⚠️' : '☁️'}</span>
                            ${appState.syncStatus === 'syncing' ? '동기화 중...' : appState.syncStatus === 'synced' ? '동기화됨' : appState.syncStatus === 'error' ? '동기화 오류' : '대기 중'}
                          </div>
                        </div>
                        <button class="logout-btn" onclick="logout()">로그아웃</button>
                      </div>
                      <div style="font-size: 12px; color: var(--text-secondary); text-align: center;">
                        다른 기기에서 같은 계정으로 로그인하면 자동 동기화됩니다
                      </div>
                    ` : `
                      <div style="text-align: center; padding: 10px 0;">
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
                          Google 계정으로 로그인하면<br>여러 기기에서 동기화할 수 있어요
                        </p>
                        <button class="login-btn" onclick="loginWithGoogle()">
                          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                          Google로 로그인
                        </button>
                      </div>
                    `}
                  </div>

                  <div class="settings-section">
                    <div class="settings-section-title">⏰ 시간 설정</div>

                    <div class="settings-row">
                      <div class="settings-label">
                        <span class="settings-label-icon">🌅</span>
                        <div class="settings-label-text">
                          <span class="settings-label-title">목표 기상 시간</span>
                          <span class="settings-label-desc">출근 준비 시작 시간</span>
                        </div>
                      </div>
                      <input
                        type="time"
                        class="settings-input"
                        value="${appState.settings.targetWakeTime || '07:00'}"
                        onchange="updateSetting('targetWakeTime', this.value)"
                      >
                    </div>

                    <div class="settings-row">
                      <div class="settings-label">
                        <span class="settings-label-icon">🏢</span>
                        <div class="settings-label-text">
                          <span class="settings-label-title">출근 시간</span>
                          <span class="settings-label-desc">회사 모드 시작</span>
                        </div>
                      </div>
                      <input
                        type="time"
                        class="settings-input"
                        value="${appState.settings.workStartTime || '11:00'}"
                        onchange="updateSetting('workStartTime', this.value)"
                      >
                    </div>

                    <div class="settings-row">
                      <div class="settings-label">
                        <span class="settings-label-icon">🚶</span>
                        <div class="settings-label-text">
                          <span class="settings-label-title">퇴근 시간</span>
                          <span class="settings-label-desc">회사 모드 종료</span>
                        </div>
                      </div>
                      <input
                        type="time"
                        class="settings-input"
                        value="${appState.settings.workEndTime || '20:00'}"
                        onchange="updateSetting('workEndTime', this.value)"
                      >
                    </div>

                    <div class="settings-row">
                      <div class="settings-label">
                        <span class="settings-label-icon">🌙</span>
                        <div class="settings-label-text">
                          <span class="settings-label-title">목표 취침 시간</span>
                          <span class="settings-label-desc">이 시간 전에 잠자리에</span>
                        </div>
                      </div>
                      <input
                        type="time"
                        class="settings-input"
                        value="${appState.settings.targetBedtime || '23:00'}"
                        onchange="updateSetting('targetBedtime', this.value)"
                      >
                    </div>

                    <!-- 타임라인 미리보기 -->
                    <div class="settings-time-preview">
                      <div class="settings-time-preview-title">📅 하루 일정 미리보기</div>
                      <div class="settings-time-preview-timeline">
                        <div class="timeline-item">
                          <span class="timeline-icon">🌅</span>
                          <span class="timeline-time">${appState.settings.targetWakeTime || '07:00'}</span>
                        </div>
                        <span class="timeline-arrow">→</span>
                        <div class="timeline-item">
                          <span class="timeline-icon">🏢</span>
                          <span class="timeline-time">${appState.settings.workStartTime || '11:00'}</span>
                        </div>
                        <span class="timeline-arrow">→</span>
                        <div class="timeline-item">
                          <span class="timeline-icon">🚶</span>
                          <span class="timeline-time">${appState.settings.workEndTime || '20:00'}</span>
                        </div>
                        <span class="timeline-arrow">→</span>
                        <div class="timeline-item">
                          <span class="timeline-icon">🌙</span>
                          <span class="timeline-time">${appState.settings.targetBedtime || '23:00'}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="settings-section">
                    <div class="settings-section-title">🎯 목표 설정</div>

                    <div class="settings-row">
                      <div class="settings-label">
                        <span class="settings-label-icon">📅</span>
                        <div class="settings-label-text">
                          <span class="settings-label-title">일일 목표</span>
                          <span class="settings-label-desc">하루에 완료할 작업 수</span>
                        </div>
                      </div>
                      <input
                        type="number"
                        class="settings-input-number"
                        min="1"
                        max="20"
                        value="${appState.settings.dailyGoal}"
                        onchange="updateSetting('dailyGoal', parseInt(this.value) || 5)"
                      >
                    </div>

                    <div class="settings-row">
                      <div class="settings-label">
                        <span class="settings-label-icon">📆</span>
                        <div class="settings-label-text">
                          <span class="settings-label-title">주간 목표</span>
                          <span class="settings-label-desc">일주일에 완료할 작업 수</span>
                        </div>
                      </div>
                      <input
                        type="number"
                        class="settings-input-number"
                        min="1"
                        max="100"
                        value="${appState.settings.weeklyGoal}"
                        onchange="updateSetting('weeklyGoal', parseInt(this.value) || 25)"
                      >
                    </div>
                  </div>

                  <div class="settings-section">
                    <div class="settings-section-title">🔔 알림 설정</div>

                    <div class="settings-row">
                      <div class="settings-label">
                        <span class="settings-label-icon">🌙</span>
                        <div class="settings-label-text">
                          <span class="settings-label-title">취침 알림</span>
                          <span class="settings-label-desc">취침 시간 전 알림 받기</span>
                        </div>
                      </div>
                      <button
                        class="btn-small ${appState.settings.bedtimeReminder ? 'complete' : ''}"
                        onclick="updateSetting('bedtimeReminder', !appState.settings.bedtimeReminder); renderStatic();"
                        style="min-width: 60px;"
                      >
                        ${appState.settings.bedtimeReminder ? 'ON' : 'OFF'}
                      </button>
                    </div>

                    ${appState.settings.bedtimeReminder ? `
                      <div class="settings-row">
                        <div class="settings-label">
                          <span class="settings-label-icon">⏰</span>
                          <div class="settings-label-text">
                            <span class="settings-label-title">알림 시간</span>
                            <span class="settings-label-desc">취침 몇 분 전에 알림</span>
                          </div>
                        </div>
                        <select
                          class="settings-input"
                          style="width: 100px;"
                          onchange="updateSetting('bedtimeReminderMinutes', parseInt(this.value))"
                        >
                          <option value="15" ${appState.settings.bedtimeReminderMinutes === 15 ? 'selected' : ''}>15분 전</option>
                          <option value="30" ${appState.settings.bedtimeReminderMinutes === 30 ? 'selected' : ''}>30분 전</option>
                          <option value="60" ${appState.settings.bedtimeReminderMinutes === 60 ? 'selected' : ''}>1시간 전</option>
                        </select>
                      </div>
                    ` : ''}
                  </div>

                  <div class="settings-section">
                    <div class="settings-section-title">💾 데이터 백업</div>
                    <div class="settings-row" style="justify-content: center; gap: 12px;">
                      <button class="backup-btn export" onclick="exportData()" style="flex: 1;">
                        📤 내보내기
                      </button>
                      <button class="backup-btn import" onclick="importData()" style="flex: 1;">
                        📥 가져오기
                      </button>
                    </div>
                    <div class="settings-label-desc" style="text-align: center; margin-top: 8px; opacity: 0.6;">
                      주기적으로 백업하여 데이터를 안전하게 보관하세요
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-primary" onclick="closeSettings()">
                    ✓ 완료
                  </button>
                </div>
              </div>
            </div>
          ` : ''}
        </div>
      `;

      // 입력 이벤트 핸들러 등록
      setupInputHandlers();
    }

    /**
     * 입력 필드 이벤트 핸들러 등록
     */
    function setupInputHandlers() {
      const quickInput = document.getElementById('quick-add-input');
      if (quickInput) {
        quickInput.oninput = (e) => {
          appState.quickAddValue = e.target.value;
        };
      }

      if (appState.showDetailedAdd) {
        const inputs = {
          title: document.getElementById('detailed-title'),
          deadline: document.getElementById('detailed-deadline'),
          time: document.getElementById('detailed-time'),
          revenue: document.getElementById('detailed-revenue'),
          link: document.getElementById('detailed-link'),
          organizer: document.getElementById('detailed-organizer'),
          eventType: document.getElementById('detailed-eventType')
        };

        if (inputs.title) inputs.title.oninput = (e) => appState.detailedTask.title = e.target.value;
        if (inputs.deadline) inputs.deadline.onchange = (e) => appState.detailedTask.deadline = e.target.value;
        if (inputs.time) inputs.time.oninput = (e) => appState.detailedTask.estimatedTime = parseInt(e.target.value) || 0;
        if (inputs.revenue) inputs.revenue.oninput = (e) => appState.detailedTask.expectedRevenue = e.target.value;
        if (inputs.link) inputs.link.oninput = (e) => appState.detailedTask.link = e.target.value;
        if (inputs.organizer) inputs.organizer.onchange = (e) => appState.detailedTask.organizer = e.target.value;
        if (inputs.eventType) inputs.eventType.onchange = (e) => appState.detailedTask.eventType = e.target.value;

        // 새 태그 입력 핸들러
        const tagInput = document.getElementById('new-tag-input');
        if (tagInput) {
          tagInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              addNewTag(e.target.value);
              e.target.value = '';
            }
          };
        }

        // 서브태스크 입력 핸들러
        const subtaskInput = document.getElementById('new-subtask-input');
        if (subtaskInput) {
          subtaskInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              addSubtask(e.target.value);
              e.target.value = '';
            }
          };
        }
      }

      // 파일 임포트 핸들러
      const fileInput = document.getElementById('file-import');
      if (fileInput) {
        fileInput.onchange = handleFileImport;
      }
    }

    /**
     * 시간만 업데이트 (1초마다)
     */
    function updateTime() {
      const now = new Date();
      const hour = now.getHours();
      const bedtime = new Date(now);
      bedtime.setHours(24, 0, 0, 0);
      const minutesUntilBed = Math.floor((bedtime - now) / (1000 * 60));

      const timeEl = document.getElementById('time-value');
      if (timeEl) {
        timeEl.textContent = `${Math.floor(minutesUntilBed / 60)}시간 ${minutesUntilBed % 60}분`;
      }

      // 현재 시간 시계 업데이트
      const clockEl = document.getElementById('current-clock');
      if (clockEl) {
        clockEl.textContent = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
      }

      // 모드 남은 시간 업데이트
      const modeTimeEl = document.getElementById('mode-time-remaining');
      if (modeTimeEl) {
        const mode = getCurrentMode();
        modeTimeEl.textContent = getModeTimeRemaining(mode, hour, now);
      }
    }

    // ============================================
    // 전역 함수 등록 (HTML에서 호출 가능하게)
    // ============================================
    window.switchTab = switchTab;
    window.addNewEvent = addNewEvent;
    window.toggleShuttle = toggleShuttle;
    window.quickAdd = quickAdd;
    window.detailedAdd = detailedAdd;
    window.completeTask = completeTask;
    window.uncompleteTask = uncompleteTask;
    window.editTask = editTask;
    window.cancelEdit = cancelEdit;
    window.deleteTask = deleteTask;
    window.handleGo = handleGo;
    window.toggleTaskList = toggleTaskList;
    window.toggleCompletedTasks = toggleCompletedTasks;
    window.toggleDetailedAdd = toggleDetailedAdd;
    window.updateDetailedTaskCategory = updateDetailedTaskCategory;
    window.updateDetailedTaskRepeat = updateDetailedTaskRepeat;
    window.handleTouchStart = handleTouchStart;
    window.handleTouchMove = handleTouchMove;
    window.handleTouchEnd = handleTouchEnd;
    window.exportData = exportData;
    window.importData = importData;
    window.getRepeatLabel = getRepeatLabel;
    window.setScheduleFilter = setScheduleFilter;
    window.getTasksByDate = getTasksByDate;
    window.formatTime = formatTime;
    window.setSearchQuery = setSearchQuery;
    window.clearSearch = clearSearch;
    window.setCategoryFilter = setCategoryFilter;

    // 히스토리/캘린더 함수
    window.prevMonth = prevMonth;
    window.nextMonth = nextMonth;
    window.selectDate = selectDate;
    window.toggleHistoryDate = toggleHistoryDate;

    // 설정 함수
    window.openSettings = openSettings;
    window.closeSettings = closeSettings;
    window.updateSetting = updateSetting;

    // 템플릿 함수
    window.saveAsTemplate = saveAsTemplate;
    window.deleteTemplate = deleteTemplate;
    window.addFromTemplate = addFromTemplate;
    window.saveCurrentAsTemplate = saveCurrentAsTemplate;

    // UX 함수
    function dismissSwipeHint() {
      localStorage.setItem('navigator-hide-swipe-hint', 'true');
      renderStatic();
    }
    window.dismissSwipeHint = dismissSwipeHint;

    // ============================================
    // PWA 및 알림 기능
    // ============================================

    let deferredPrompt = null; // PWA 설치 프롬프트 저장

    /**
     * Service Worker 등록
     */
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('./sw.js');
          console.log('Service Worker 등록 성공:', registration.scope);
        } catch (error) {
          console.error('Service Worker 등록 실패:', error);
        }
      }
    }

    /**
     * 알림 권한 요청
     */
    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        showToast('이 브라우저는 알림을 지원하지 않습니다', 'error');
        return;
      }

      try {
        const permission = await Notification.requestPermission();
        appState.notificationPermission = permission;
        renderStatic();

        if (permission === 'granted') {
          showToast('알림이 활성화되었습니다!', 'success');
          // 테스트 알림
          showNotification('Navigator 알림 활성화', '마감 임박 시 알림을 받을 수 있습니다');
        } else if (permission === 'denied') {
          showToast('알림이 차단되었습니다. 브라우저 설정에서 허용해주세요', 'error');
        }
      } catch (error) {
        console.error('알림 권한 요청 실패:', error);
      }
    }

    /**
     * 알림 표시
     */
    function showNotification(title, body) {
      if (Notification.permission === 'granted') {
        const options = {
          body: body,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23667eea" width="100" height="100" rx="20"/><text x="50" y="68" font-size="50" text-anchor="middle" fill="white">⚡</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23f5576c" width="100" height="100" rx="50"/></svg>',
          vibrate: [100, 50, 100],
          tag: 'navigator-reminder',
          renotify: true
        };

        new Notification(title, options);
      }
    }

    /**
     * 마감 임박 작업 확인 및 알림 (5분마다 실행)
     */
    function checkDeadlinesAndNotify() {
      if (Notification.permission !== 'granted') return;

      const now = new Date();
      const notifiedKey = 'navigator-notified-tasks';
      let notifiedTasks = [];

      try {
        notifiedTasks = JSON.parse(localStorage.getItem(notifiedKey) || '[]');
      } catch (e) {
        notifiedTasks = [];
      }

      // 작업 마감 알림
      appState.tasks.forEach(task => {
        if (task.completed || !task.deadline) return;

        const deadline = new Date(task.deadline);
        const hoursLeft = (deadline - now) / (1000 * 60 * 60);
        const taskNotifyKey = `${task.id}-${Math.floor(hoursLeft)}`;

        // 3시간 전 알림 (한 번만)
        if (hoursLeft > 0 && hoursLeft <= 3 && !notifiedTasks.includes(taskNotifyKey + '-3h')) {
          showNotification(
            '🚨 마감 3시간 전!',
            `"${task.title}" 마감이 임박했습니다`
          );
          notifiedTasks.push(taskNotifyKey + '-3h');
        }

        // 1시간 전 알림 (한 번만)
        if (hoursLeft > 0 && hoursLeft <= 1 && !notifiedTasks.includes(taskNotifyKey + '-1h')) {
          showNotification(
            '⚠️ 마감 1시간 전!',
            `"${task.title}" 지금 바로 시작하세요`
          );
          notifiedTasks.push(taskNotifyKey + '-1h');
        }
      });

      // 취침 알림 체크
      if (appState.settings.bedtimeReminder) {
        checkBedtimeReminder(now, notifiedTasks);
      }

      // 24시간 이상 된 알림 기록은 삭제
      const recentNotified = notifiedTasks.slice(-100);
      localStorage.setItem(notifiedKey, JSON.stringify(recentNotified));
    }

    /**
     * 취침 알림 체크
     */
    function checkBedtimeReminder(now, notifiedTasks) {
      const bedtimeStr = appState.settings.targetBedtime;
      const [bedHour, bedMinute] = bedtimeStr.split(':').map(Number);
      const reminderMinutes = appState.settings.bedtimeReminderMinutes || 30;

      // 오늘 취침 시간
      const bedtime = new Date(now);
      bedtime.setHours(bedHour, bedMinute, 0, 0);

      // 만약 현재 시간이 취침 시간 이후면, 이미 지난 것이므로 무시
      if (now > bedtime) return;

      const minutesUntilBed = (bedtime - now) / (1000 * 60);
      const todayKey = `bedtime-${now.toDateString()}`;

      // 설정된 시간 전 알림 (한 번만)
      if (minutesUntilBed > 0 && minutesUntilBed <= reminderMinutes && !notifiedTasks.includes(todayKey)) {
        const incompleteTasks = appState.tasks.filter(t => !t.completed).length;
        let message = '';

        if (incompleteTasks > 0) {
          message = `아직 ${incompleteTasks}개 작업이 남았어요. 마무리하고 잠자리에 들어요!`;
        } else {
          message = '오늘 목표를 다 달성했어요! 푹 쉬세요 😴';
        }

        showNotification(
          `🌙 취침 ${reminderMinutes}분 전!`,
          message
        );
        notifiedTasks.push(todayKey);
      }
    }

    /**
     * PWA 설치 프롬프트 처리
     */
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // 설치 배너 표시
      const banner = document.getElementById('install-banner');
      if (banner) banner.classList.add('show');
    });

    /**
     * PWA 설치
     */
    async function installPWA() {
      if (!deferredPrompt) return;

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        showToast('앱이 설치되었습니다!', 'success');
      }

      deferredPrompt = null;
      const banner = document.getElementById('install-banner');
      if (banner) banner.classList.remove('show');
    }

    /**
     * 설치 배너 닫기
     */
    function closeInstallBanner() {
      const banner = document.getElementById('install-banner');
      if (banner) banner.classList.remove('show');
      deferredPrompt = null;
    }

    window.requestNotificationPermission = requestNotificationPermission;
    window.installPWA = installPWA;
    window.closeInstallBanner = closeInstallBanner;

    // ============================================
    // 키보드 단축키
    // ============================================

    let showShortcutsHelp = false;

    /**
     * 단축키 도움말 토글
     */
    function toggleShortcutsHelp() {
      showShortcutsHelp = !showShortcutsHelp;
      const helpEl = document.getElementById('shortcuts-help');
      if (helpEl) {
        helpEl.classList.toggle('show', showShortcutsHelp);
      }
    }

    /**
     * 키보드 이벤트 핸들러
     */
    document.addEventListener('keydown', (e) => {
      // 입력 필드에서는 단축키 비활성화
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        // Escape는 입력 필드에서도 동작
        if (e.key === 'Escape') {
          e.target.blur();
          return;
        }
        return;
      }

      // Ctrl/Cmd + 키 조합
      if (e.ctrlKey || e.metaKey) {
        switch (e.key.toLowerCase()) {
          case 'n': // 새 작업 추가
            e.preventDefault();
            const quickInput = document.getElementById('quick-add-input');
            if (quickInput) {
              quickInput.focus();
            }
            break;
          case 'f': // 검색
            e.preventDefault();
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
              searchInput.focus();
            }
            break;
          case 'd': // Next Action 완료
            e.preventDefault();
            const filteredTasks = getFilteredTasks();
            if (filteredTasks.length > 0) {
              completeTask(filteredTasks[0].id);
            }
            break;
          case '/': // 단축키 도움말
            e.preventDefault();
            toggleShortcutsHelp();
            break;
        }
        return;
      }

      // 단일 키
      switch (e.key) {
        case '1':
          switchTab('action');
          break;
        case '2':
          switchTab('schedule');
          break;
        case '3':
          switchTab('dashboard');
          break;
        case 's':
          toggleShuttle();
          break;
        case '?':
          toggleShortcutsHelp();
          break;
        case 'Escape':
          if (showShortcutsHelp) {
            toggleShortcutsHelp();
          }
          if (appState.showDetailedAdd) {
            cancelEdit();
          }
          break;
      }
    });

    window.toggleShortcutsHelp = toggleShortcutsHelp;

    // ============================================
    // 포모도로 타이머
    // ============================================

    let pomodoroInterval = null;

    /**
     * 포모도로 시작
     */
    function startPomodoro(taskId = null) {
      const pomo = appState.pomodoro;

      if (taskId) {
        pomo.currentTaskId = taskId;
      } else {
        // Next Action 사용
        const filtered = getFilteredTasks();
        if (filtered.length > 0) {
          pomo.currentTaskId = filtered[0].id;
        }
      }

      pomo.isRunning = true;
      pomo.isBreak = false;
      pomo.timeLeft = pomo.workDuration;

      if (pomodoroInterval) clearInterval(pomodoroInterval);
      pomodoroInterval = setInterval(pomodoroTick, 1000);

      renderStatic();
      showToast('포모도로 시작! 25분 집중하세요', 'success');

      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    /**
     * 포모도로 일시정지
     */
    function pausePomodoro() {
      appState.pomodoro.isRunning = false;
      if (pomodoroInterval) {
        clearInterval(pomodoroInterval);
        pomodoroInterval = null;
      }
      renderStatic();
    }

    /**
     * 포모도로 재개
     */
    function resumePomodoro() {
      appState.pomodoro.isRunning = true;
      pomodoroInterval = setInterval(pomodoroTick, 1000);
      renderStatic();
    }

    /**
     * 포모도로 중지
     */
    function stopPomodoro() {
      const pomo = appState.pomodoro;
      pomo.isRunning = false;
      pomo.isBreak = false;
      pomo.timeLeft = pomo.workDuration;
      pomo.currentTaskId = null;

      if (pomodoroInterval) {
        clearInterval(pomodoroInterval);
        pomodoroInterval = null;
      }

      renderStatic();
      showToast('포모도로 중지됨', 'error');
    }

    /**
     * 휴식 건너뛰기
     */
    function skipBreak() {
      const pomo = appState.pomodoro;
      pomo.isBreak = false;
      pomo.timeLeft = pomo.workDuration;
      renderStatic();
      showToast('휴식 건너뜀! 다시 집중하세요', 'success');
    }

    /**
     * 포모도로 틱 (1초마다 실행)
     */
    function pomodoroTick() {
      const pomo = appState.pomodoro;

      if (pomo.timeLeft > 0) {
        pomo.timeLeft--;
        updatePomodoroDisplay();
      } else {
        // 시간 종료
        if (pomo.isBreak) {
          // 휴식 종료 → 작업 시작
          pomo.isBreak = false;
          pomo.timeLeft = pomo.workDuration;
          showNotification('휴식 끝!', '다시 집중할 시간입니다');
          showToast('휴식 끝! 다시 집중하세요', 'success');
        } else {
          // 작업 종료 → 휴식 시작
          pomo.completedPomodoros++;
          pomo.isBreak = true;
          pomo.timeLeft = pomo.breakDuration;
          showNotification('포모도로 완료!', '5분 휴식하세요');
          showToast(`포모도로 완료! (${pomo.completedPomodoros}회) 5분 휴식`, 'success');
        }

        if (navigator.vibrate) {
          navigator.vibrate([200, 100, 200, 100, 200]);
        }

        renderStatic();
      }
    }

    /**
     * 포모도로 시간 표시 업데이트 (전체 렌더링 없이)
     */
    function updatePomodoroDisplay() {
      const timeEl = document.getElementById('pomodoro-time');
      if (timeEl) {
        timeEl.textContent = formatPomodoroTime(appState.pomodoro.timeLeft);
      }
    }

    /**
     * 포모도로 시간 포맷팅
     */
    function formatPomodoroTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    window.startPomodoro = startPomodoro;
    window.pausePomodoro = pausePomodoro;
    window.resumePomodoro = resumePomodoro;
    window.stopPomodoro = stopPomodoro;
    window.skipBreak = skipBreak;
    window.formatPomodoroTime = formatPomodoroTime;

    // ============================================
    // 앱 초기화
    // ============================================
    loadState();

    // 알림 권한 상태 확인
    if ('Notification' in window) {
      appState.notificationPermission = Notification.permission;
    }

    // 오프라인 상태 표시
    function updateOnlineStatus() {
      let indicator = document.getElementById('offline-indicator');

      if (!navigator.onLine) {
        if (!indicator) {
          indicator = document.createElement('div');
          indicator.id = 'offline-indicator';
          indicator.className = 'offline-indicator';
          indicator.innerHTML = '📴 오프라인 모드 - 변경사항은 기기에 저장됩니다';
          document.body.prepend(indicator);
        }
        indicator.classList.remove('hidden');
      } else {
        if (indicator) {
          indicator.classList.add('hidden');
          setTimeout(() => indicator.remove(), 300);
        }
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    renderStatic();
    registerServiceWorker();
    setInterval(updateTime, 1000);
    setInterval(checkDeadlinesAndNotify, 5 * 60 * 1000); // 5분마다 마감 체크
    checkDeadlinesAndNotify(); // 초기 실행

    // Firebase 인증 상태 리스너
    window.addEventListener('firebase-ready', () => {
      window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
          appState.user = {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL
          };

          // 클라우드 데이터 로드 및 실시간 동기화 시작
          await loadFromFirebase();
          startRealtimeSync();

          renderStatic();
        } else {
          appState.user = null;
          appState.syncStatus = 'offline';
          renderStatic();
        }
      });
    });
  </script>
</body>
</html>
